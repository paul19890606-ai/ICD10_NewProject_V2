<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ICD-10-CM Tabular è©³æƒ…</title>
    <style>
        /* ==================================== */
        /* ğŸ¨ å…¨å±€å’Œä¸»è¦ä½ˆå±€å„ªåŒ– (é–“è·ç·Šæ¹Š) */
        /* ==================================== */
        body { 
            font-family: Arial, sans-serif; 
            padding: 15px; 
            background-color: #e9ebee; 
        }
        
        #detail-view { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            border: 1px solid #ccc; 
            background-color: #ffffff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            border-radius: 8px; 
        }
        
        .back-link { 
            margin-bottom: 15px; 
            display: block; 
            font-size: 1.0em; 
            color: #007bff; 
            text-decoration: none; 
        }
        .back-link:hover { text-decoration: underline; }

        /* é ‚å±¤ Category æ¨™é¡Œ */
        #detail-view h2 { 
            color: #d9534f; 
            border-bottom: 2px solid #d9534f; 
            padding-bottom: 5px; 
            margin-top: 5px; 
            margin-bottom: 10px; 
            font-size: 1.8em;
            display: flex; 
            align-items: baseline; 
        }
        
        /* ä»£ç¢¼æœ¬èº« (Code) */
        .category-code {
            font-size: 1.2em; 
            margin-right: 15px;
            font-weight: bold; 
        }

        /* æè¿° (Description) */
        .category-description {
            font-size: 1em; 
            font-weight: bold; 
            color: #333; 
        }
        /* --- é ‚å±¤æ¨™é¡Œ CSS ä¿®æ­£çµæŸ --- */

        /* é ‚å±¤ Category æè¿° */
        #detail-view > p:nth-of-type(1) { 
            margin-bottom: 15px; 
            margin-top: -5px; 
        }
        
        /* å°‡ Category ä¸»å…§å®¹å€å¡Šèˆ‡ Sub-codes åˆ†éš” */
        #category-main-content {
            border-bottom: 1px solid #ddd; 
            padding-bottom: 15px; 
            margin-bottom: 15px; 
        }

        /* å­ä»£ç¢¼æ¸…å–®æ¨™é¡Œ */
        #detail-view h3 { 
            color: #333; 
            border-bottom: 1px solid #ccc; 
            padding-bottom: 5px; 
            margin-top: 20px; 
            margin-bottom: 10px; 
            font-size: 1.4em;
        }
        
        /* ==================================== */
        /* ğŸ“„ Notes/Instructions å€å¡Šå„ªåŒ– (åˆ—è¡¨ç·Šæ¹Š) */
        /* ==================================== */
        .notes-box { 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-left: 4px solid; 
            background-color: #fcfcfc; 
            border-radius: 4px;
        }
        .notes-box h5 { 
            margin-top: 0; 
            margin-bottom: 3px; 
            font-size: 1.0em; 
        } 
        .notes-list { 
            list-style-type: disc; 
            padding-left: 20px; 
            margin-top: 3px; 
            margin-bottom: 0; 
            font-size: 0.95em; 
        }
        .notes-list li { 
            margin-bottom: 2px; /* é—œéµï¼šæ¸›å°åˆ—è¡¨é …ç›®é–“è· */
        }

        /* 7ç¢¼è¦æ±‚æ¡† */
        .extension-box { 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-left: 4px solid #f0ad4e; 
            background-color: #fff9e9; 
            border-radius: 4px;
        }
        .extension-box h5 { margin-top: 0; margin-bottom: 3px; color: #ec971f; font-size: 1.0em; }
        .extension-box p { margin: 0; font-size: 0.95em; }
        
        /* ==================================== */
        /* ğŸ§© Sub-code æ¢ç›®å„ªåŒ– */
        /* ==================================== */
        .sub-code-entry { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: #ffffff; 
            border-radius: 5px; 
            border-left: 4px solid; 
        }
        .sub-code-entry h4 { 
            margin: 0 0 3px 0; 
            color: #333; 
            font-size: 1.1em; 
            /* ä¿æŒ display: flex å’Œ align-items: baseline ç¢ºä¿å‚ç›´å°é½Š */
            display: flex; 
            align-items: baseline;
        } 

        .sub-code-entry h4 .code-description {
            font-weight: bold; /* æè¿°åŠ ç²— */
            font-style: normal;
            color: #333; 
            margin-left: 10px;
            
            /* --- ä¿®æ­£é»ï¼šç§»é™¤ auto marginï¼Œè¨­å®šå›ºå®šé–“è· --- */
            margin-right: 8px; 
            /* --- ä¿®æ­£é»çµæŸ --- */
        }
        
        .sub-ext-box { 
            margin-left: 10px !important; 
            margin-right: 0 !important;
            margin-top: 5px;
            margin-bottom: 5px !important;
        }
        
        /* éè¿´é¡¯ç¤ºçš„å­å±¤æ¬¡ç¸®é€² */
        .nested-sub-codes {
            margin-left: 15px; 
            border-left: 1px dashed #ccc;
            padding-left: 10px; 
            margin-top: 10px; 
        }

        /* å®Œæ•´æ€§æ¨™ç±¤æ¨£å¼ */
        .status-label {
            font-size: 0.8em; 
            padding: 2px 5px; 
            border-radius: 3px;
            margin-left: 8px;
            display: inline-block;
            font-weight: bold;
        }
        .status-incomplete {
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .status-complete {
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">â¬…ï¸ è¿”å›ä¸»æœç´¢é </a>
    <div id="detail-view">
        <p>è¼‰å…¥ä¸­...</p>
    </div>

    <script>
        const JSON_FILE_NAME = 'data_tabular_index.json'; 
        
        let tabularData = null;
        const detailViewDiv = document.getElementById('detail-view');

        async function loadJson(file) {
            try {
                const response = await fetch(file);
                if (!response.ok) {
                    throw new Error(`Failed to load ${file}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error loading ${file}:`, error);
                detailViewDiv.innerHTML = `<p style="color: red;">ğŸš¨ ç„¡æ³•è¼‰å…¥ Tabular æ•¸æ“šæºï¼š${file}ã€‚</p>
                                           <p style="color: red;">**è«‹ç¢ºèªæ‚¨å·²åŸ·è¡Œæœ€æ–°ç‰ˆçš„ <code>convert.js</code> è…³æœ¬ï¼Œä¸”è¼¸å‡ºçš„ <code>${file}</code> æª”æ¡ˆä¸ç‚ºç©ºã€‚**</p>`;
                return null;
            }
        }
        
        function generateNotesHtml(notes) {
            if (!notes || notes.length === 0) return '';
            
            let html = '';
            
            const groupedNotes = notes.reduce((acc, note) => {
                const type = note.type || 'Notes'; 
                if (!acc[type]) acc[type] = [];
                acc[type].push(note.text);
                return acc;
            }, {});

            const order = ['Excludes1', 'Excludes2', 'Code First', 'Use Additional Code', 'Includes', 'Notes'];
            const typeColors = {
                'Excludes1': '#dc3545', 
                'Excludes2': '#ffc107', 
                'Code First': '#007bff', 
                'Use Additional Code': '#17a2b8', 
                'Includes': '#28a745', 
                'Notes': '#6c757d' 
            };
            
            order.forEach(type => {
                const noteTexts = groupedNotes[type];
                if (noteTexts && noteTexts.length > 0) {
                     const color = typeColors[type] || '#6c757d';
                     
                     html += `<div class="notes-box" style="border-left-color: ${color};">
                         <h5 style="color: ${color};">ğŸ“ ${type} (Guidance):</h5>
                         <ul class="notes-list">
                             ${noteTexts.map(text => `<li>${text}</li>`).join('')}
                         </ul>
                     </div>`;
                     delete groupedNotes[type]; 
                }
            });
            
            for (const type in groupedNotes) {
                 const noteTexts = groupedNotes[type];
                 html += `<div class="notes-box">
                     <h5>ğŸ“ ${type} (Other Guidance):</h5>
                     <ul class="notes-list">
                         ${noteTexts.map(text => `<li>${text}</li>`).join('')}
                     </ul>
                 </div>`;
            }
            
            return html;
        }

        function recursiveRenderSubs(entries, level = 0) {
            const subCodes = Object.keys(entries).sort();
            if (subCodes.length === 0) return '';
            
            let html = '';
            
            const containerClass = level > 0 ? 'nested-sub-codes' : '';
            html += `<div class="${containerClass}">`;

            const levelColor = `hsl(200, 70%, ${50 - level * 5}%)`; 

            subCodes.forEach(subCode => {
                const subData = entries[subCode]; 
                
                const hasSubcodes = subData.subs && Object.keys(subData.subs).length > 0;
                const requiresExtension = subData.ext !== null;
                
                let statusLabel = '';
                if (hasSubcodes) {
                    statusLabel = `<span class="status-label status-incomplete">éå®Œæ•´ç·¨ç¢¼ (éœ€ç´°åˆ†)</span>`;
                } else if (requiresExtension) {
                    statusLabel = `<span class="status-label status-complete">å®Œæ•´ç·¨ç¢¼ (éœ€å»¶ä¼¸)</span>`;
                } else {
                    statusLabel = `<span class="status-label status-complete">å®Œæ•´ç·¨ç¢¼</span>`;
                }
                
                html += `<div class="sub-code-entry" style="border-left-color: ${levelColor};">
                    <h4>
                        <span>${subCode}</span>
                        <span class="code-description">${subData.d}</span>
                        ${statusLabel}
                    </h4>
                    
                    `;

                html += generateNotesHtml(subData.notes);
                
                if (subData.ext) {
                    html += `<div class="extension-box sub-ext-box">
                        <h5>ğŸ“Œ 7 ç¢¼å»¶ä¼¸å­—å…ƒè¦æ±‚ (Ext) for ${subCode}:</h5>
                        <p>${subData.ext}</p>
                    </div>`;
                }

                if (hasSubcodes) {
                    html += recursiveRenderSubs(subData.subs, level + 1);
                }

                html += `</div>`; 
            });
            
            html += `</div>`; 
            return html;
        }

        function showCategoryDetail(categoryCode) {
            const categoryData = tabularData[categoryCode];

            if (!categoryData) {
                detailViewDiv.innerHTML = `<h2>ğŸš¨ éŒ¯èª¤ï¼šæœªåœ¨ Tabular List ä¸­æ‰¾åˆ°ä»£ç¢¼ ${categoryCode} çš„è©³ç´°è³‡è¨Šã€‚</h2>
                                           <p>è«‹ç¢ºèªæ‚¨å·²åŸ·è¡Œæœ€æ–°ç‰ˆçš„ <code>convert.js</code> è…³æœ¬ã€‚</p>`;
                return;
            }

            // é ‚å±¤ Category æ¨™é¡Œçµæ§‹ä¿æŒä¸è®Šï¼ˆä»£ç¢¼ + æè¿°ï¼‰
            let detailHtml = `
                <h2>
                    <span class="category-code">${categoryCode}</span> 
                    <span class="category-description">${categoryData.d}</span>
                </h2>
                <p style="font-style: italic; color: #666; font-size: 0.9em;">ï¼ˆæ­¤è™•é¡¯ç¤º ICD-10-CM Tabular List ä¸­ ${categoryCode} åˆ†é¡çš„è©³ç´°æŒ‡å¼•ï¼‰</p>
            `;
            
            detailHtml += `<div id="category-main-content">`;
            
            detailHtml += generateNotesHtml(categoryData.notes);
            
            if (categoryData.ext) {
                detailHtml += `<div class="extension-box">
                    <h5>ğŸ“Œ 7 ç¢¼å»¶ä¼¸å­—å…ƒè¦æ±‚ (Ext) for ${categoryCode}:</h5>
                    <p>${categoryData.ext}</p>
                </div>`;
            }
            
            detailHtml += `</div>`; 

            const subEntries = categoryData.subs || {}; 
            const totalSubCodes = Object.keys(subEntries).length;
            
            if (totalSubCodes > 0) {
                detailHtml += `<h3>åŒ…å«çš„å­ä»£ç¢¼åˆ—è¡¨ (ç¸½è¨ˆ ${totalSubCodes} å€‹é ‚å±¤å­ä»£ç¢¼)</h3>`;
                detailHtml += recursiveRenderSubs(subEntries);
            } else {
                 detailHtml += `<p style="font-style: italic; color: #666;">æ­¤ Category (${categoryCode}) åœ¨ Tabular List ä¸­æ²’æœ‰å®šç¾© Sub-code åˆ—è¡¨ã€‚</p>`;
            }

            detailViewDiv.innerHTML = detailHtml;
        }

        async function initializeDetail() {
            const params = new URLSearchParams(window.location.search);
            const targetCode = params.get('code');

            if (!targetCode) {
                detailViewDiv.innerHTML = '<h2>ğŸš¨ éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘ä»£ç¢¼åƒæ•¸ (code)ã€‚</h2>';
                return;
            }

            const tabularJson = await loadJson(JSON_FILE_NAME);
            if (!tabularJson) return;

            tabularData = tabularJson;

            const categoryCode = targetCode.substring(0, 3);
            showCategoryDetail(categoryCode);
        }

        initializeDetail();
    </script>

</body>
</html>