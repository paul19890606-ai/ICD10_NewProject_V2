<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ICD-10-CM/PCS 模糊搜索 (V4 - 條列式樣式 + 強化類型標示)</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        
        /* 載入動畫 */
        .loading-dot { display: inline-block; width: 8px; height: 8px; background-color: orange; border-radius: 50%; margin-left: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* --- 標題和狀態列的容器 --- */
        #title-container {
            display: flex; 
            align-items: flex-end; 
            margin-bottom: 15px;
        }

        #title-container h2 {
            margin: 0;
            padding-right: 20px; 
        }

        #status-bar-info {
            font-size: 0.75em; 
            color: #555;
            padding: 5px 10px;
            border-left: 3px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            flex-grow: 1; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #status-line {
            display: inline; 
        }
        
        /* --- 篩選器容器樣式 --- */
        #filter-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f7f7f7;
            border: 1px solid #eee;
            border-radius: 5px;
            font-size: 1.0em;
        }
        #filter-container label {
            margin-right: 20px;
            font-weight: 600;
            color: #333;
            display: inline-flex;
            align-items: center;
        }
        #filter-container input[type="radio"] { 
            margin-right: 5px;
            transform: scale(1.1);
        }

        /* ***** 核心變動：搜索列容器 (使用 Flexbox) ***** */
        #search-bar-container {
            display: flex;
            align-items: center; 
            justify-content: space-between; /* 將左右元素推開 */
            margin-bottom: 25px;
            margin-top: 10px;
        }
        
        /* 搜索控制項 (輸入框 + 按鈕) */
        #search-controls {
            display: flex;
            align-items: center; 
            /* 移除原有的 margin-bottom */
        }
        
        #search-input { 
            padding: 10px; 
            width: 450px; 
            font-size: 16px; 
            border: 1px solid #ccc; 
            flex-shrink: 0; 
        }
        
        /* 按鈕樣式調整 */
        .nav-button {
            padding: 10px 15px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px; 
            border: none;
            border-radius: 5px; 
            transition: background-color 0.3s, transform 0.1s;
            height: 40px; 
            line-height: 20px; 
        }
        .nav-button:hover {
            transform: translateY(-1px);
        }
        #pcs-button {
            background-color: #008080; 
            color: white;
        }
        #cm-button {
            background-color: #0056b3; 
            color: white;
        }
        
        /* ***** 核心變動：結果數量顯示 ***** */
        #result-count-info {
            font-size: 0.9em;
            color: #333;
            font-weight: bold;
            white-space: nowrap; /* 防止文字換行 */
            margin-left: 20px;
            flex-shrink: 0;
            text-align: right;
        }

        /* 統一的代碼顯示樣式 */
        .search-result-code { 
            font-weight: bold; 
            color: #0056b3; 
            margin-right: 10px; 
            display: inline-block;
        } 
        
        /* 其他通用樣式 */
        .is-clickable { cursor: pointer !important; text-decoration: underline !important; }
        .see-link { cursor: pointer; color: #d9534f; text-decoration: underline; margin-left: 5px; font-weight: bold; }
        .source { font-size: 0.8em; color: #666; margin-left: 10px; }
        
        /* ================================================= */
        /* --- 特殊列表的樣式 (舊條列式) --- */
        /* ================================================= */
        
        /* 1. 特殊列表 (Neoplasm, E-Index, Drug) 的容器 */
        .special-table-result {
            margin-bottom: 8px;
            border-radius: 5px;
            overflow: hidden;
        }
        .special-table-result table {
            width: 100%;
            border-collapse: collapse;
        }
        .special-table-result td {
            padding: 10px 12px;
            vertical-align: top;
            font-size: 1.0em;
        }
        .special-table-code-col {
            width: 120px; 
            font-weight: bold;
            flex-shrink: 0;
            border-right: 1px dashed #ccc;
        }
        /* 腫瘤/外傷/外因 - 紫色調 */
        .neoplasm-row, .eindex-row {
            background-color: #f7e6f7; /* 淺紫色 */
            border: 1px solid #e0cce0;
            border-left: 5px solid #9932cc; /* 左邊的紫色線 */
        }
        /* 中毒/藥物 - 橘色調 */
        .drug-row {
            background-color: #fff0e6; 
            border: 1px solid #ffe0cc;
            border-left: 5px solid #ff7b00; 
        }

        /* 3. 一般索引結果 (維持白色) */
        .result-item { 
            border: 1px solid #eee; 
            padding: 10px; 
            margin-bottom: 5px; 
            background-color: #fff; 
        }
        
        /* ***** 強化腫瘤類型標籤樣式 ***** */
        .neoplasm-type-tag {
            font-weight: 900; /* 極粗體 */
            font-size: 1.05em; /* 稍微大一點 */
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            white-space: nowrap; /* 不換行 */
            display: inline-block;
        }
        /* --- 特殊列表樣式結束 --- */

        /* 隱藏 V26 的 PCS 區塊樣式 */
        #pcs-search-container, #pcs-results { display: none; }
    </style>
</head>
<body>

    <div id="main-content">
        
        <div id="title-container">
            <h2>ICD-10-CM/PCS 數據模糊搜索 (整合頁)</h2>
            
            <div id="status-bar-info">
                <span id="status-line">
                    數據載入狀態: 
                    <span id="status-cm" style="color: orange;">CM Index 載入中<span class="loading-dot"></span></span> |
                    <span id="status-tabular" style="color: orange;">Tabular 載入中<span class="loading-dot"></span></span> |
                    <span id="status-pcs" style="color: orange;">PCS Index 載入中<span class="loading-dot"></span></span>
                    
                    <span id="total-codes" style="font-weight: bold; margin-left: 15px;"></span>
                </span>
            </div>
        </div>
        
        <div id="filter-container">
            <label>
                <input type="radio" name="search-filter" id="filter-special" data-filter="Special"> 
                腫瘤/外傷/中毒列表
            </label>
            <label>
                <input type="radio" name="search-filter" id="filter-general" data-filter="General" checked> 
                一般索引/Tabular
            </label>
            <span id="filter-note" style="margin-left: 10px; font-size: 0.9em; color: #6c757d;">（一次只能選擇一個數據源進行搜索）</span>
        </div>


        <div id="search-bar-container">
            <div id="search-controls">
                <input type="text" id="search-input" placeholder="輸入 CM 或 PCS 關鍵字 (例如：肺炎, 腎臟)" autofocus>
                
                <button id="cm-button" class="nav-button" onclick="alert('目前 CM/PCS 整合搜索已涵蓋 CM 索引。');">CM 詳盡搜索</button>
                <button id="pcs-button" class="nav-button" onclick="window.location.href='search_pcs.html'">PCS 專門搜索</button>
            </div>
            
            <span id="result-count-info"></span> 
        </div>
        
        <div id="results">
            <p>數據已載入。請在上方輸入框中輸入關鍵字或代碼進行模糊搜索。</p>
        </div>
    </div>

    <script>
        console.error = console.error.bind(console, 'APP ERROR:'); 

        let fullIndex = []; 
        let tabularData = {}; 
        let isDataLoaded = false;
        const resultsDiv = document.getElementById('results');
        const searchInput = document.getElementById('search-input');
        const resultCountInfo = document.getElementById('result-count-info'); // 獲取新的元素
        let fuse; 
        
        // --- 輔助函數 ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        async function loadJson(fileName, statusElementId, source) {
            const statusElement = document.getElementById(statusElementId);
            try {
                // 修正：為了繞過快取，加入時間戳
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(fileName + cacheBuster);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }
                const data = await response.json();
                statusElement.innerHTML = `${source} 載入成功`;
                statusElement.style.color = 'green';
                return data;
            } catch (error) {
                statusElement.innerHTML = `${source} 載入失敗: ${error.message}`;
                statusElement.style.color = 'red';
                console.error(`載入 ${fileName} 失敗:`, error);
                return null;
            }
        }
        
        function processIndexData(data) {
            if (!data) return [];
            return data.map(item => ({
                code: item.code || item.c, 
                description: item.description || item.t,
                source: item.source || 'CM Index', 
                see: item.see || null,       
                seeAlso: item.seeAlso || null, 
                use: item.use || null        
            }));
        }

        function processTabularData(data) {
            tabularData = data || {}; 
            const list = [];
            if (!data) return [];
            
            for (const categoryCode in data) {
                const categoryEntry = data[categoryCode];
                list.push({ code: categoryCode, description: categoryEntry.d, source: 'Tabular Category' });
                const subEntries = categoryEntry.subs || categoryEntry.ch; 
                
                if (subEntries) {
                    for (const subCode in subEntries) {
                        const subEntry = subEntries[subCode];
                        list.push({ code: subCode, description: subEntry.d, source: 'Tabular Sub-Code' });
                    }
                }
            }
            return list;
        }

        function getActiveFilters() {
            const filters = [];
            
            const isSpecialChecked = document.getElementById('filter-special').checked;
            
            if (isSpecialChecked) {
                filters.push('Special'); // 包含 Neoplasm, Drug, E-Index
            } else { 
                filters.push('General'); // 包含 CM Index, Tabular, PCS Index
            }
            
            return filters;
        }

        function filterIndexData(activeFilters) {
            const SPECIAL_SOURCES = ['Neoplasm', 'Drug', 'E-Index'];

            return fullIndex.filter(item => {
                
                const isSpecial = SPECIAL_SOURCES.includes(item.source);

                // 1. 檢查是否在特殊列表模式下
                if (activeFilters.includes('Special')) { 
                    if (isSpecial) return true;
                }
                
                // 2. 檢查是否在一般索引模式下
                if (activeFilters.includes('General')) {
                     // 排除特殊列表的來源
                     if (!isSpecial) {
                        return true;
                    }
                }

                return false;
            });
        }
        
        // --- 點擊跳轉/搜索函數 ---
        function navigateToDetail(code) {
            const categoryCode = code.substring(0, 3); 
            window.location.href = `detail.html?code=${categoryCode}`;
        }
        
        function navigateToSearch(term) {
            searchInput.value = term; 
            searchCode(); 
        }

        // --- 渲染函數：特殊列表 (統一渲染 Neoplasm, Drug, E-Index) ---
        function renderStandardSpecialTable(item) {
            const rowClass = item.source.includes('Drug') ? 'drug-row' : 
                             item.source.includes('Neoplasm') ? 'neoplasm-row' : 
                             'eindex-row';
            
            const codePrefix = item.code ? item.code.substring(0, 3) : null;
            const isClickable = item.code && item.code.length >= 3 && codePrefix in tabularData;
            const clickableClass = isClickable ? 'is-clickable' : '';
            // Neoplasm 使用紫色，Drug 使用橘色
            const codeColor = item.source.includes('Neoplasm') ? '#9932cc' : 
                              item.source.includes('Drug') ? '#ff7b00' : 
                              '#0096d6';
            
            let codeCell;
            let descriptionCell = item.description;

            // ***** 強化腫瘤類型標示邏輯開始 *****
            let codeTypeHtml = '';
            let cleanedDescription = item.description;
            
            if (item.source.includes('Neoplasm')) {
                const neoplasmTypes = ['MalignantPrimary', 'MalignantSecondary', 'CaInSitu', 'Benign', 'UncertainBehavior', 'UnspecifiedBehavior'];
                
                let foundType = null;
                for (const type of neoplasmTypes) {
                    if (item.description.endsWith(`, ${type}`)) {
                        foundType = type;
                        cleanedDescription = item.description.substring(0, item.description.length - (`, ${type}`).length);
                        break;
                    }
                }
                
                if (foundType) {
                    // 設定不同類型的顏色
                    const typeColors = {
                        'MalignantPrimary': '#B22222',       // 消防磚紅 (最醒目)
                        'MalignantSecondary': '#CC0000',     // 深紅
                        'CaInSitu': '#A0522D',               // 土色
                        'Benign': '#228B22',                 // 森林綠
                        'UncertainBehavior': '#FF8C00',      // 暗橙色
                        'UnspecifiedBehavior': '#556B2F'     // 軍綠色
                    };
                    
                    const color = typeColors[foundType] || '#708090'; 
                    
                    // 使用新的 class 和顏色，並加上邊框來強化視覺效果
                    codeTypeHtml = `<span class="neoplasm-type-tag" style="color: ${color}; border: 1px solid ${color};">
                                        ${foundType}
                                   </span>`;
                    descriptionCell = cleanedDescription;
                } else {
                    descriptionCell = item.description; 
                }
            } else {
                descriptionCell = item.description;
            }
            // ***** 強化腫瘤類型標示邏輯結束 *****
            
            
            if (item.code) {
                codeCell = `<span class="search-result-code ${clickableClass}" 
                                data-code="${item.code}" 
                                data-clickable="${isClickable}"
                                style="color: ${codeColor};">
                             ${item.code}
                           </span>`;
            } else {
                codeCell = '-';
            }

            let refLinkHtml = '';
            if (!item.code && (item.see || item.use)) { 
                if (item.see) {
                    refLinkHtml = `<span style="font-style: italic;">SEE:</span> 
                                   <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
                } else if (item.use) {
                    refLinkHtml = `<span style="font-style: italic;">USE:</span> 
                                   <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
                }
                descriptionCell = refLinkHtml; 
            } else if (item.seeAlso) {
                refLinkHtml = `<span style="font-style: italic; margin-left: 15px;">SEE ALSO:</span> 
                               <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
                descriptionCell += refLinkHtml; 
            }


            return `<div class="special-table-result ${rowClass}">
                        <table>
                            <tbody>
                                <tr>
                                    <td class="special-table-code-col">${codeCell}</td>
                                    <td>
                                        ${descriptionCell}
                                        ${codeTypeHtml}  
                                        <span class="source">[${item.source}]</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;
        }


        function renderGeneralIndexItem(item) {
            let codeHtml = '';
            let mainContentHtml = item.description;
            let refLinkHtml = '';

            // 只有 CM Index 或 Tabular 數據才檢查是否可點擊
            const isCMData = item.source.includes('Index') || item.source.includes('Tabular');
            
            if (item.code) {
                const codePrefix = item.code.substring(0, 3);
                // CM 數據才檢查 Tabular
                const isClickable = isCMData && item.code.length >= 3 && codePrefix in tabularData;
                const clickableClass = isClickable ? 'is-clickable' : '';
                // PCS Index 使用藍綠色, CM Index/Tabular 使用藍色
                const codeColor = item.source.includes('PCS Index') ? '#008080' : '#0056b3'; 
                
                codeHtml = `<span class="search-result-code ${clickableClass}" 
                                  data-code="${item.code}" 
                                  data-clickable="${isClickable}"
                                  style="color: ${codeColor};">
                                ${item.code}
                            </span>`;
            }

            if (!item.code && (item.see || item.use)) { 
                if (item.see) {
                    refLinkHtml = `<span style="font-style: italic;">SEE:</span> 
                                   <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
                } else if (item.use) {
                    refLinkHtml = `<span style="font-style: italic;">USE:</span> 
                                   <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
                }
                mainContentHtml = refLinkHtml; 
            } else if (item.seeAlso) {
                refLinkHtml = `<span style="font-style: italic; margin-left: 15px;">SEE ALSO:</span> 
                               <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
                mainContentHtml += refLinkHtml; 
            }
            
            return `<div class="result-item">
                        ${codeHtml}
                        ${mainContentHtml}
                        <span class="source">[${item.source}]</span>
                    </div>`;
        }

        // --- 搜索主函數 ---
        function searchCode() {
            try {
                if (!isDataLoaded) {
                    resultsDiv.innerHTML = '<p style="color: red;">數據仍在載入中，請稍候。</p>';
                    resultCountInfo.textContent = '';
                    return;
                }
                
                const query = searchInput.value.trim();
                resultsDiv.innerHTML = '';
                resultCountInfo.textContent = ''; // 每次搜索前清空

                if (query.length === 0) {
                    resultsDiv.innerHTML = '<p>請在上方輸入框中輸入關鍵字或代碼進行模糊搜索。</p>';
                    return;
                }
                if (query.length < 2) {
                    resultsDiv.innerHTML = '<p>請輸入至少兩個字符進行搜索。</p>';
                    return;
                }

                const activeFilters = getActiveFilters();
                const filteredData = filterIndexData(activeFilters);
                
                if (filteredData.length === 0) {
                     resultsDiv.innerHTML = '<p>根據您選擇的篩選條件，無符合搜索範圍的數據集。</p>';
                     return;
                }
                
                const options = {
                    keys: ['code', 'description', 'see', 'seeAlso', 'use'], 
                    threshold: 0.3, 
                    includeMatches: true, 
                    ignoreLocation: true 
                };
                const tempFuse = new Fuse(filteredData, options);
                const MAX_RESULTS = 500;
                const fuseResults = tempFuse.search(query); 

                // 排序和去重邏輯
                const queryLower = query.toLowerCase();
                fuseResults.sort((a, b) => {
                    const calculateCustomScore = (item) => {
                        const code = item.code ? item.code.trim().toLowerCase() : '';
                        const desc = item.description ? item.description.trim().toLowerCase() : '';
                        
                        if (code === queryLower) return 4;
                        if (code.startsWith(queryLower)) return 3;
                        if (desc === queryLower) return 2;
                        if (desc.startsWith(queryLower)) return 1;
                        return 0; 
                    };
                    
                    const customScoreA = calculateCustomScore(a.item);
                    const customScoreB = calculateCustomScore(b.item);
                    
                    if (customScoreA !== customScoreB) {
                        return customScoreB - customScoreA;
                    }
                    if (a.score !== b.score) {
                        return a.score - b.score;
                    }
                    return 0; 
                });
                
                const uniqueResults = [];
                const seenKeys = new Set();
                
                for (const result of fuseResults) {
                    const item = result.item;
                    const key = `${item.code || ''}|${item.description}`; 
                    
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueResults.push(item); 
                    }
                }

                const filteredResults = uniqueResults.slice(0, MAX_RESULTS);

                // 顯示結果
                if (filteredResults.length === 0) {
                    resultsDiv.innerHTML = `<p>找不到與 "${query}" 相關的代碼或描述。請檢查篩選條件。</p>`;
                    resultCountInfo.textContent = '0 條結果';
                } else {
                    const filterName = activeFilters[0] === 'Special' ? '特殊列表 (腫瘤/外傷/中毒)' : '一般索引/Tabular';
                    
                    // ***** 核心變動：更新結果數量顯示在上方 *****
                    resultCountInfo.textContent = `找到 ${filteredResults.length} 條結果 (前 ${MAX_RESULTS} 條, 數據範圍: ${filterName})：`;

                    // 僅將實際的結果列表放入 resultsDiv
                    let html = '<div class="result-container">';
                    
                    filteredResults.forEach(item => {
                        const isSpecial = item.source.includes('Neoplasm') || item.source.includes('Drug') || item.source.includes('E-Index');
                        
                        if (isSpecial) {
                            html += renderStandardSpecialTable(item);
                        } else {
                            html += renderGeneralIndexItem(item);
                        }
                    });

                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    
                    // 註冊點擊事件
                    document.querySelectorAll('#results .search-result-code, #results .neoplasm-code-link').forEach(span => {
                        const code = span.dataset.code;
                        const isClickable = span.dataset.clickable === 'true';

                        if (code && isClickable) { 
                             span.addEventListener('click', (e) => navigateToDetail(code));
                        }
                    });
                    
                    document.querySelectorAll('#results .see-link').forEach(span => {
                        span.addEventListener('click', (e) => {
                            const term = e.target.dataset.searchTerm;
                            if (term) navigateToSearch(term);
                        });
                    });
                }
            } catch (e) {
                console.error('Search function error:', e);
            }
        }
        
        const debouncedSearch = debounce(searchCode, 300); 

        // --- 主載入和初始化 ---
        async function initialize() {
            try {
                // 數據檔案名假設與 convert.js 產出的名稱一致
                const [cmIndex, tabularJson, pcsIndexData] = await Promise.all([
                    loadJson('data_cm_index.json', 'status-cm', 'CM Index'),
                    loadJson('data_tabular_index.json', 'status-tabular', 'Tabular List'),
                    loadJson('data_pcs_index.json', 'status-pcs', 'PCS Index')
                ]);

                const cmList = processIndexData(cmIndex);
                const pcsList = processIndexData(pcsIndexData);
                const tabularList = processTabularData(tabularJson); 
                
                fullIndex = [...cmList, ...pcsList, ...tabularList];

                fullIndex.forEach((item, index) => {
                    item.originalIndex = index;
                });

                if (cmIndex && tabularJson && pcsIndexData) {
                     isDataLoaded = true;
                }
                
                document.getElementById('total-codes').textContent = `| 總計: ${fullIndex.length} 條。`;
                
                searchInput.addEventListener('input', debouncedSearch);
                
                // 註冊篩選器的 change 事件
                document.querySelectorAll('#filter-container input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', debouncedSearch);
                });
                
                searchCode(); // 首次執行搜索

            } catch (e) {
                console.error('Initialization failed:', e);
                resultsDiv.innerHTML = `<p style="color: red;">應用初始化失敗。請檢查控制台錯誤。</p>`;
            }
        }

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchCode();
            }
        });

        // 啟動應用
        initialize();
    </script>

</body>
</html>