<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ICD-10-CM/PCS搜索</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        
        /* ... (CSS 樣式保持不變) ... */
        .loading-dot { display: inline-block; width: 8px; height: 8px; background-color: orange; border-radius: 50%; margin-left: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* ***** [新增/修改]：讓標頭懸浮的容器樣式 ***** */
        #sticky-header-container {
            /* 1. 設置為懸浮定位 */
            position: sticky; 
            /* 2. 固定在頁面頂部 0 像素處 */
            top: 0; 
            /* 3. 設置背景色以覆蓋下方的內容 */
            background-color: #ffffff; 
            /* 4. 增加陰影以提供視覺上的懸浮感 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            /* 5. 確保懸浮元素位於最上層 */
            z-index: 100; 
            /* 6. 增加底部間距以分隔內容和懸浮頭 */
            margin-bottom: 15px;
            padding-top: 10px; 
            padding-bottom: 5px; 
        }
        /* *************************************** */
        
        #title-container { display: flex; align-items: flex-end; margin-bottom: 15px; }
        #title-container h2 { margin: 0; padding-right: 20px; }
        #status-bar-info { font-size: 0.75em; color: #555; padding: 5px 10px; border-left: 3px solid #ccc; background-color: #f9f9f9; border-radius: 4px; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #status-line { display: inline; }
        
        /* --- 篩選器容器樣式 (已移除，但 CSS 保持不動，以防未來恢復) --- */
        #filter-container { margin-bottom: 15px; padding: 10px; background-color: #f7f7f7; border: 1px solid #eee; border-radius: 5px; font-size: 1.0em; display: none; /* V15 修正：隱藏容器，保持結構 */ }
        #filter-container label { margin-right: 20px; font-weight: 600; color: #333; display: inline-flex; align-items: center; }
        #filter-container input[type="radio"] { margin-right: 5px; transform: scale(1.1); }

        /* ***** 搜索列容器 (Flexbox) ***** */
        #search-bar-container { margin-bottom: 25px; margin-top: 10px; }
        #search-controls-row { display: flex; align-items: center; justify-content: flex-start; gap: 10px; }
        /* === 關鍵修改：讓輸入框佔據可用空間，將後續元素推向右側 === */
        #search-input { padding: 10px; min-width: 200px; font-size: 16px; border: 1px solid #ccc; flex-grow: 1; flex-shrink: 1; }
        
        #nav-buttons-group { display: flex; align-items: center; flex-shrink: 0; }
        .nav-button { padding: 10px 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-left: 5px; border: none; border-radius: 5px; transition: background-color 0.3s, transform 0.1s; height: 40px; line-height: 20px; flex-shrink: 0; }
        #nav-buttons-group .nav-button:first-child { margin-left: 0; }
        #pcs-button { background-color: #008080; color: white; }
        #cm-button { background-color: #0056b3; color: white; }
        .nav-button:hover { transform: translateY(-1px); }
        
        /* #result-count-info 的樣式被移除，因為它不再是一個獨立的元素，而是嵌入在 status-bar-info 中 */
        #search-time-info { 
            font-size: 1em; 
            color: #d9534f; /* 使用紅色來強調搜索結果資訊 */
            font-weight: bold; 
            margin-left: 15px; 
        }

        .special-result-button { padding: 8px 15px; font-size: 15px; font-weight: bold; cursor: pointer; border-radius: 5px; border: 2px solid; background-color: #f7f7f7; transition: all 0.2s; flex-shrink: 0; line-height: 1.2; text-align: center; height: 40px; color: white; }
        .special-result-button:hover { background-color: #fff; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; }
        .button-count { font-weight: 900; margin-left: 5px; }
        
        .search-result-code { font-weight: bold; color: #0056b3; margin-right: 10px; display: inline-block; } 
        .is-clickable { cursor: pointer !important; text-decoration: underline !important; }
        .see-link { cursor: pointer; color: #d9534f; text-decoration: underline; margin-left: 5px; font-weight: bold; }
        .source { font-size: 0.8em; color: #666; margin-left: 10px; }
        
        
        /* ================================================= */
        /* --- 特殊列表的表格化樣式 (Neoplasm Table 樣式) --- */
        /* ================================================= */
        
        /* 容器僅用於邊界和左側顏色條 - 啟用內部滾動 */
        .special-table-result {
            margin-bottom: 0; 
            border-radius: 0; 
            /* --- 關鍵修改 --- */
            max-height: 500px; /* 設定一個固定的最大高度，您可以根據需要調整 */
            overflow-y: scroll; /* 內容超出高度時顯示垂直滾動條 */
            /* --- 關鍵修改結束 --- */
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background-color: #fff; /* 確保背景是白色，以便交替行工作 */
        }
        
        /* 表格本身 */
        .special-table-result table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* 表格標頭 - 關鍵修改：讓表頭固定在**容器**的頂部 */
        .neoplasm-table-header th {
            text-align: center;
            padding: 8px 5px;
            font-size: 0.9em;
            background-color: #e6e6fa; /* Neoplasm 標頭的柔和紫色背景 */
            border: 1px solid #ccc;
            white-space: nowrap;
            font-weight: bold;
            
            /* === 實現固定表頭的關鍵屬性 === */
            position: sticky; 
            top: 0; 
            z-index: 10; /* 確保它在滾動時位於內容上方 */
        }

        /* 表格單元格 */
        .special-table-result td {
            padding: 6px 8px; 
            vertical-align: middle;
            font-size: 1.0em;
            border-right: 1px solid #eee; 
            border-bottom: none; 
            text-align: center; 
        }
        
        /* 索引詞欄位 (最左邊的欄位) */
        .neoplasm-term-col {
            width: 30%; 
            text-align: left !important; /* 左對齊 */
            font-weight: 500;
            /* background-color: #fff;  <-- V13 修正：移除固定白色，允許繼承交替行顏色 */
            border-right: 2px solid #aaa !important; /* 加強索引詞和代碼列的分隔 */
        }
        
        /* 代碼欄位 (右側的六個分類欄位) */
        .neoplasm-code-col {
            width: 10%; 
            white-space: nowrap;
            font-size: 0.9em;
            text-align: center !important; /* *** V14 修正：代碼置中對齊 *** */
            border-right: 1px dotted #ccc; 
        }
        .neoplasm-code-col:last-child {
            border-right: none; /* 移除最右邊的點線分隔 */
        }

        /* ** V20 修正：為表格內的代碼設置強制樣式 ** */
        .neoplasm-code-col span, .neoplasm-code-col a {
            font-weight: bold !important;
            color: #333 !important; /* 確保代碼有顏色 */
            display: inline-block !important; /* 確保代碼佔據空間 */
            min-width: 50px; /* 確保代碼有最小寬度 */
        }
        /* ----------------------------------------------- */
        /* ******** 優化：交替行顏色 (Zebra Stripes) ******** */
        /* ----------------------------------------------- */
        
        /* 預設行樣式，用於 Neoplasm */
        .neoplasm-row {
            border-left: 5px solid #9932cc; /* 左側邊界顏色 */
            background-color: #fff; 
        }
        /* 偶數行 (從 tbody 第二行開始計算) 設置不同的背景色 */
        .neoplasm-row:nth-child(even) {
            background-color: #f0f0f8; /* 柔和的淺紫色 */
        }
        
        /* 應用到整個容器，設置左邊界顏色和背景色 - Drug */
        .drug-row {
            border-left: 5px solid #ff7b00;
            background-color: #fff;
        }
        .drug-row:nth-child(even) {
            background-color: #fff0e6; /* 柔和的淺橘色 */
        }

        /* 應用到整個容器，設置左邊界顏色和背景色 - E-Index */
        /* 列表項目排版 (General & E-Index Rows) */
    .eindex-row {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 8px 10px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .eindex-row:hover {
        background-color: #f5f5f5;
    }
        /* ----------------------------------------------- */
        
        
        /* 3. 一般索引結果 (維持白色) */
        .result-item { 
            border: 1px solid #eee; 
            padding: 10px; 
            margin-bottom: 5px; 
            background-color: #fff; 
        }

/* === 核心修改：強制固定代碼欄位寬度並右對齊 === */
    .eindex-code-area {
        /* 設置為固定寬度 (足夠容納 7 碼代碼 + 點 + 邊距) */
        width: 140px !important; /* 增加寬度以確保容納 7 碼 */
        min-width: 140px !important; 
        flex-shrink: 0 !important;
        padding-right: 15px;
        border-right: 3px solid #ccc; /* 用來分隔的垂直線，顏色在 JS 中動態設定 */
        text-align: right !important; /* 強制代碼右對齊 */
    }
    .search-result-code {
        font-weight: bold;
        font-size: 1.1em;
        /* 確保代碼本身不換行 */
        white-space: nowrap;
        /* 將代碼移動到右側，並為 <a> 標籤定義懸停樣式 */
        display: inline-block;
        /* 確保最小寬度，即便代碼是 '-' */
        min-width: 80px; 
    }
    .search-result-code.is-clickable {
        text-decoration: none;
        border-bottom: 1px dotted; /* 讓連結看起來更明顯 */
    }
    .search-result-code.is-clickable:hover {
        border-bottom-style: solid;
        color: #d32f2f !important;
    }
    /* =================================== */

    /* 內容欄位 */
    .eindex-content-area {
        /* 讓內容欄位佔滿剩餘空間 */
        flex-grow: 1; 
        padding-left: 15px;
        font-size: 0.95em;
        color: #333;
        line-height: 1.4;
    }
    /* ... (其餘 CSS 樣式保持不變) ... */

    </style>
</head>
<body>

    <div id="main-content">
        
        <div id="sticky-header-container"> 
            
            <div id="title-container">
                <h2>ICD-10-CM/PCS 搜索</h2>
                
                <div id="status-bar-info">
                    <span id="initial-load-status">數據載入中...</span>
                    <span id="total-codes" style="font-weight: bold; margin-left: 15px;"></span>
                    <span id="search-time-info" style="font-weight: bold; margin-left: 15px;"></span>
                </div>
            </div>
            
            <div id="search-bar-container">
                
                <div id="search-controls-row">
                    
                    <input type="text" id="search-input" placeholder="輸入 CM 或 PCS 關鍵字 (例如：肺炎, 腎臟)" autofocus>
                    
                    <div id="special-buttons-row">
                        </div>
                    
                    <div id="nav-buttons-group">
                        <button id="cm-button" class="nav-button" onclick="searchCode();">重新查詢</button>
                        <button id="pcs-button" class="nav-button" onclick="window.location.href='search_pcs.html'">PCS 專門搜索</button>
                    </div>
                </div>
            </div>

            <div id="filter-container" style="display: none;"> 
                </div>

        </div>
        <div id="results">
            <p>數據已載入。請在上方輸入框中輸入關鍵字或代碼進行模糊搜索。</p>
        </div>
    </div>

    <script>
        console.error = console.error.bind(console, 'APP ERROR:'); 

        let fullIndex = []; 
        let tabularData = {}; 
        let isDataLoaded = false;
        const resultsDiv = document.getElementById('results');
        const searchInput = document.getElementById('search-input');
        // const resultCountInfo = document.getElementById('result-count-info'); // **已移除**
        const searchTimeInfo = document.getElementById('search-time-info'); // **新增變數**
        let fuse; 
        
        let currentSpecialResults = []; 
        
        // Neoplasm 和 Drug 表格的代碼欄位映射 (英文標頭)
        const NEOPLASM_COLUMNS_MAP = {
            'MalignantPrimary': 'Malignant Primary', 
            'MalignantSecondary': 'Malignant Secondary', 
            'CaInSitu': 'Ca in situ', 
            'Benign': 'Benign', 
            'UncertainBehavior': 'Uncertain Behavior', 
            'UnspecifiedBehavior': 'Unspecified Behavior'
        };
        const DRUG_COLUMNS = ['PoisoningAccident', 'PoisoningIntentionalSelfHarm', 'PoisoningAssault', 'PoisoningUndetermined', 'AdverseEffect', 'Underdosing'];


        // --- 輔助函數 ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        
        async function loadJson(fileName, statusElementId, source) {
            const statusElement = document.getElementById(statusElementId);
            try {
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(fileName + cacheBuster);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }
                const data = await response.json();
                // 簡化：移除單獨的狀態更新，交由 initialize() 統一處理
                return data;
            } catch (error) {
                // 如果載入失敗，我們仍然需要在控制台記錄錯誤
                // 為了保持載入動畫期間的狀態，我們仍然需要一個臨時的載入元素
                console.error(`載入 ${fileName} 失敗:`, error);
                return null;
            }
        }
        
        function processIndexData(data) {
            if (!data) return [];
            return data.map(item => ({
                code: item.code || item.c, 
                description: item.description || item.t, 
                source: item.source || 'CM Index', 
                see: item.see || null,       
                seeAlso: item.seeAlso || null, 
                use: item.use || null,
                // 傳遞 specialCodes，用於 Neoplasm/Drug 表格渲染
                specialCodes: item.specialCodes || null 
            }));
        }

        function processTabularData(data) {
            tabularData = data || {}; 
            const list = [];
            if (!data) return [];
            
            for (const categoryCode in data) {
                const categoryEntry = data[categoryCode];
                list.push({ code: categoryCode, description: categoryEntry.term || categoryEntry.d, source: 'Tabular Category' }); 
                const subEntries = categoryEntry.subs || categoryEntry.ch; 
                
                if (subEntries) {
                    for (const subCode in subEntries) {
                        const subEntry = subEntries[subCode];
                        list.push({ code: subCode, description: subEntry.term || subEntry.d, source: 'Tabular Sub-Code' });
                    }
                }
            }
            return list;
        }

        // V15 修正：由於移除了篩選器，強制設置為 'General' 模式
        function getActiveFilters() {
            return ['General']; 
        }
        
        function navigateToDetail(code) {
            const categoryCode = code.substring(0, 3); 
            // 這裡可以導航到詳細頁面，或只是彈出提示
            alert(`導航到代碼 ${categoryCode} 的 Tabular 詳細頁面。`);
            // window.location.href = `detail.html?code=${categoryCode}`;
        }
        
        function navigateToSearch(term) {
            searchInput.value = term; 
            searchCode(); 
        }

        // --- 點擊摘要方框後顯示特定清單的函數 ---
        function showSpecialList(source, count) {
            const listContainer = document.getElementById('detailed-list-container');
            
            if (!listContainer || !currentSpecialResults.length) {
                return; 
            }
            
            const targetResults = currentSpecialResults.filter(item => item.source.includes(source));
            
            const sourceMapName = {
                'Neoplasm': '腫瘤 (Neoplasm)',
                'Drug': '中毒/藥物 (Drug)',
                'E-Index': '外傷/外部原因 (E-Index)'
            };
            const name = sourceMapName[source] || source;

            // 1. 準備表格標頭 
            let tableHeader = '';
            const isNeoplasmOrDrug = (source === 'Neoplasm' || source === 'Drug');

            if (isNeoplasmOrDrug) {
                 // 使用多欄位表格標頭
                const columns = source === 'Neoplasm' ? Object.values(NEOPLASM_COLUMNS_MAP) : ['Accident', 'Self-Harm', 'Assault', 'Undetermined', 'Adverse Effect', 'Underdosing'];
                const headers = [source === 'Neoplasm' ? 'Neoplasm' : 'Drug/Substance', ...columns];
                
                tableHeader = `<thead>
                                    <tr class="neoplasm-table-header">
                                        ${headers.map(h => `<th>${h}</th>`).join('')}
                                    </tr>
                                </thead>`;
            } else {
                // E-Index 或其他，使用簡化標頭
                tableHeader = `<thead>
                                    <tr class="neoplasm-table-header">
                                        <th style="width: 30%;">E-Index Term</th>
                                        <th style="width: 70%;" colspan="6">Code/Reference</th>
                                    </tr>
                                </thead>`;
            }


            // 2. 準備 HTML 結構
            let listHtml = `
                <h3 style="margin-top: 20px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px;">
                    ${name} 詳細清單 (${targetResults.length} 條結果)
                </h3>
                <div id="detailed-results-list" class="result-container">
            `;
            
            if (targetResults.length === 0) {
                listHtml += `<p style="color: #999; text-align: center; margin-top: 15px;">
                                找不到與 ${name} 相關的結果。
                             </p>`;
            } else {
                 if (isNeoplasmOrDrug) {
                    // 使用特殊表格容器
                    listHtml += `<div class="special-table-result">
                                 <table style="width: 100%; border-collapse: collapse; border-top: 2px solid #ccc;">
                                    ${tableHeader}
                                    <tbody>`;
                    
                    targetResults.forEach(item => {
                        listHtml += renderStandardSpecialTable(item); // 渲染多欄位表格
                    });
                    
                    listHtml += `</tbody></table></div>`;
                } else {
                    // E-Index 使用單行渲染
                    targetResults.forEach(item => {
                        listHtml += renderEIndexItem(item); 
                    });
                }
            }
            
            listHtml += '</div>';

            // 3. 替換容器內容
            listContainer.innerHTML = listHtml;
            
            // 4. 註冊新的點擊事件
            registerClickHandlers(); 
        }

        // --- 點擊事件註冊函數 ---
        function registerClickHandlers() {
            document.querySelectorAll('#results .search-result-code[data-clickable="true"]').forEach(span => {
                span.onclick = () => navigateToDetail(span.dataset.code);
            });
            
            document.querySelectorAll('#results .see-link').forEach(span => {
                span.onclick = (e) => {
                    const term = e.target.dataset.searchTerm;
                    if (term) navigateToSearch(term);
                };
            });

            document.querySelectorAll('.special-result-button').forEach(button => {
                 button.onclick = (e) => {
                    const target = e.currentTarget; 
                    const source = target.dataset.source;
                    const count = target.dataset.count;
                    showSpecialList(source, count);
                };
            });
        }


    // --- 渲染函數：特殊列表 (多欄位表格 - Neoplasm & Drug) ---
function renderStandardSpecialTable(item) {
    const rowClass = item.source.includes('Drug') ? 'drug-row' : item.source.includes('Neoplasm') ? 'neoplasm-row' : '';
    const isNeoplasm = item.source.includes('Neoplasm');
    const isDrug = item.source.includes('Drug');
    let termCell = item.description;

    // V22 修正: 腫瘤表和藥物表**不顯示** SEE/USE/SEE ALSO 連結，因為它們在索引詞欄位中會顯得擁擠。
    let refLinkHtml = '';
    
    // 以下原始代碼區塊被註釋掉，以移除 SEE/USE/SEE ALSO 邏輯
    /* if (!item.code && (item.see || item.use)) {
        if (item.see) {
            refLinkHtml = `<span style="font-style: italic;">SEE:</span> <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
        } else if (item.use) {
            refLinkHtml = `<span style="font-style: italic;">USE:</span> <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
        }
        termCell = refLinkHtml;
    } else if (item.seeAlso) {
        refLinkHtml = `<span style="font-style: italic; margin-left: 10px;">SEE ALSO:</span> <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
        termCell += refLinkHtml;
    }
    */

    let rowContent = '';
    // 1. 索引詞欄位 (保持不變)
    rowContent += `<td class="neoplasm-term-col">${termCell} <span class="source">[${item.source}]</span></td>`;

    // 2. 處理多欄位代碼 (使用 col2, col3... 鍵)
    if (isNeoplasm || isDrug) {
        // 取得所有代碼欄位的鍵名
        const columns = isNeoplasm ? Object.keys(NEOPLASM_COLUMNS_MAP) : DRUG_COLUMNS;
        const codes = item.specialCodes || {};
        
        let colNum = 1; // 從 col2 開始對應
        
        const codeCellsHtml = columns.map(colKey => {
            colNum++; // colNum 會是 2, 3, 4, 5, 6, 7
            // 由於 convert.js 是將 XML 的 col="N" 轉為 JSON 的 "colN" 鍵，所以使用 `col${colNum}`
            const code = codes[`col${colNum}`] || '-'; 
            
            // 檢查是否為 CM 代碼 (字母開頭)
            const isCMCode = code.match(/^[A-TV-Z]\d{2}/i);
            
            const codePrefix = code.substring(0, 3);
            const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
            
            let cellContent = code;
            
            if (code !== '-') {
                 // 確保代碼被強制樣式化
                 if (isTabularLink) {
                    // 替換為 <a href...> 連結
                    cellContent = `<a href="tabular_view.html?code=${codePrefix}" class="is-clickable" style="text-decoration: none; color: inherit;" title="點擊查看 ${codePrefix}.XX 詳目表 (Tabular List) 資訊">${code}</a>`;
                 } else {
                    // 如果不是連結，用 span 包裝以繼承 .neoplasm-code-col span 的強制樣式
                    cellContent = `<span>${code}</span>`;
                 }
            }
            // If code is '-', cellContent remains '-'

            return `<td class="neoplasm-code-col">${cellContent}</td>`;
        }).join('');
        
        rowContent += codeCellsHtml;
    }

    // 3. 返回完整的表格行 HTML (保持不變)
    return `<tr class="${rowClass}">${rowContent}</tr>`;
}

// --- 渲染函數：E-Index (簡潔列表 - 外傷/外部原因) ---
function renderEIndexItem(item) {
    const rowClass = item.source.includes('E-Index') ? 'eindex-row' : '';
    let code = item.code || '-';
    let mainContentHtml = item.description;

    // 處理 SEE/USE/SEE ALSO 邏輯 
    let refLinkHtml = '';
    if (item.see || item.use || item.seeAlso) {
        if (item.see) {
            refLinkHtml = `<span style="font-style: italic;">SEE:</span> <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
        } else if (item.use) {
            refLinkHtml = `<span style="font-style: italic;">USE:</span> <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
        } else if (item.seeAlso) {
            refLinkHtml = `<span style="font-style: italic;">SEE ALSO:</span> <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
        }
        
        // V18 修正：將引用連結追加到 description 後，而不是替換它
        mainContentHtml += `<span style="margin-left: 15px;"></span>` + refLinkHtml;

        // 如果是純引用條目且沒有代碼，代碼顯示為 "-"
        if (!item.code) {
             code = '-'; 
        }
    }

    // 代碼顏色邏輯 (與原版保持一致)
    const codeColor = code.startsWith('Y') ? '#d9534f' : '#0096d6';
    
    // 檢查是否為 CM 代碼
    const isCMCode = code.match(/^[A-TV-Z]\d{2}/i);
    
    const codePrefix = code.substring(0, 3);
    const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
    const clickableClass = isTabularLink ? 'is-clickable' : '';
    
    let codeHtml = '-';
    if (code !== '-') {
        if (isTabularLink) {
             codeHtml = `<a href="tabular_view.html?code=${codePrefix}" class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor};" title="點擊查看 ${codePrefix}.XX 詳目表 (Tabular List) 資訊">${code}</a>`;
    } else {
             codeHtml = `<span class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor};">${code}</span>`;
        }
    }


    return `
        <div class="${rowClass}">
            <div class="eindex-code-area" style="border-right-color: ${codeColor}">
                ${codeHtml}
            </div>
            <div class="eindex-content-area">
                ${mainContentHtml}
                <span class="source">[${item.source}]</span>
            </div>
        </div>
    `;
}

 // --- 渲染函數：一般索引項目 (CM Index, Tabular List) ---
function renderGeneralIndexItem(item) {
    const rowClass = (item.source.includes('Index') || item.source.includes('Tabular')) ? 'eindex-row' : ''; 
    let code = item.code || '-';
    let mainContentHtml = item.description;

    // 處理 SEE/USE/SEE ALSO 邏輯
    let refLinkHtml = '';
    if (item.see || item.use || item.seeAlso) {
        if (item.see) {
            refLinkHtml = `<span style="font-style: italic;">SEE:</span> <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
        } else if (item.use) {
            refLinkHtml = `<span style="font-style: italic;">USE:</span> <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
        } else if (item.seeAlso) {
            refLinkHtml = `<span style="font-style: italic;">SEE ALSO:</span> <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
        }
        
        // V18 修正：將引用連結追加到 description 後，而不是替換它
        mainContentHtml += `<span style="margin-left: 15px;"></span>` + refLinkHtml;

        // 如果是純引用條目且沒有代碼，代碼顯示為 "-"
        if (!item.code) {
             code = '-'; 
        }
    }

    // 代碼顏色邏輯 (與原版保持一致)
    const codeColor = item.source.includes('Tabular') ? '#008080' : '#0056b3';
    
    // 檢查是否為 CM 代碼
    const isCMData = item.source.includes('Index') || item.source.includes('Tabular');
    const isCMCode = isCMData && code.match(/^[A-TV-Z]\d{2}/i);

    const codePrefix = code.substring(0, 3);
    // 判斷是否為 Tabular Link：必須是 CM code 且前三碼存在於 tabularData
    const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
    const clickableClass = isTabularLink ? 'is-clickable' : '';
    
    let codeHtml = '-';
    if (code !== '-') {
        if (isTabularLink) {
             // 替換為 <a href...> 連結
             codeHtml = `<a href="tabular_view.html?code=${codePrefix}" class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor}; margin-right: 0;" title="點擊查看 ${codePrefix}.XX 詳目表 (Tabular List) 資訊">${code}</a>`;
    } else {
             // 保持原來的 <span>
             codeHtml = `<span class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor}; margin-right: 0;">${code}</span>`;
        }
    }


    return `
        <div class="${rowClass}">
            <div class="eindex-code-area" style="border-right-color: ${codeColor}">
                ${codeHtml}
            </div>
            <div class="eindex-content-area">
                ${mainContentHtml}
                <span class="source">[${item.source}]</span>
            </div>
        </div>
    `;
}

        // --- 搜索主函數 (V18 移除去重邏輯) ---
        function searchCode() {
             try {
                const query = searchInput.value.trim();
                resultsDiv.innerHTML = '';
                searchTimeInfo.textContent = ''; 
                currentSpecialResults = []; 

                if (!isDataLoaded || query.length === 0 || query.length < 2) {
                    if (!isDataLoaded) resultsDiv.innerHTML = '<p style="color: red;">數據仍在載入中，請稍候。</p>';
                    if (query.length === 0) resultsDiv.innerHTML = '<p>請在上方輸入框中輸入關鍵字或代碼進行模糊搜索。</p>';
                    if (query.length > 0 && query.length < 2) resultsDiv.innerHTML = '<p>請輸入至少兩個字符進行搜索。</p>';
                    document.getElementById('special-buttons-row').innerHTML = '';
                    return;
                }

                const startTime = performance.now();
                const activeFilters = getActiveFilters(); 
                const queryLower = query.toLowerCase();

                const fuseOptions = {
                    keys: ['code', 'description', 'see', 'seeAlso', 'use'], 
                    threshold: 0.35, 
                    includeScore: true,
                    ignoreLocation: true,
                    distance: 100
                };
                
                const fuse = new Fuse(fullIndex, fuseOptions);
                let fuseResults = fuse.search(query); 

                let counts = {
                    Neoplasm: { name: '腫瘤', count: 0, color: '#9932cc' },
                    Drug: { name: '中毒/藥物', count: 0, color: '#ff7b00' },
                    EIndex: { name: '外傷/外部原因', count: 0, color: '#0096d6' },
                };
                const PRIORITY_SOURCES = ["Neoplasm", "Drug", "E-Index"];
                
                fuseResults = fuseResults.map(result => {
                    const item = result.item;
                    const source = item.source;
                    let score = result.score;
                    
                    if (source.includes('Neoplasm')) {
                        counts.Neoplasm.count++;
                    } else if (source.includes('Drug')) {
                        counts.Drug.count++;
                    } else if (source.includes('E-Index')) {
                        counts.EIndex.count++;
                    }
                    
                    let scoreAdjustment = 0;
                    if (PRIORITY_SOURCES.includes(source)) {
                        scoreAdjustment += 0.08; 
                    }
                    if (item.code && item.code.trim().toLowerCase() === queryLower) {
                        scoreAdjustment += 0.2; 
                    } else if (item.code && item.code.trim().toLowerCase().startsWith(queryLower)) {
                        scoreAdjustment += 0.1; 
                    }

                    /* * ******** 【新增優化邏輯：子條目/修飾詞分數提升】 ******** */
                    const descriptionLower = item.description.toLowerCase();
                    const queryIndex = descriptionLower.indexOf(queryLower);

                    if (queryIndex !== -1) {
                         // 檢查搜索詞後是否緊跟著括號、破折號或逗號 (表示後面是修飾詞/子條目)
                         const nextCharIndex = queryIndex + queryLower.length;
                         const nextChar = descriptionLower.charAt(nextCharIndex);
                         
                         // 僅在搜索詞是描述中的**第一個詞**且後面跟著修飾符時才加權。
                         // 例如: 'Dermatitis' -> 'Dermatitis(eczematous)'
                         if (queryIndex === 0 && (nextChar === '(' || nextChar === ',' || nextChar === '-')) {
                            // 給予較高的權重，使其排在直接匹配的 Tabular 條目之後，但在普通的 Index 條目之前。
                            scoreAdjustment += 0.15; 
                         }
                    }
                    /* * ******** 【新增優化邏輯結束】 ******** */
                    
                    result.adjustedScore = Math.max(0, score - scoreAdjustment);
                    return result;
                });
                
                fuseResults.sort((a, b) => a.adjustedScore - b.adjustedScore);

                const endTime = performance.now();
                const searchTime = (endTime - startTime).toFixed(2);

                const filterMode = activeFilters[0]; 


                const totalSpecial = counts.Neoplasm.count + counts.Drug.count + counts.EIndex.count;
                
                let specialButtonsHtml = '';
                
                if (totalSpecial > 0) {
                     specialButtonsHtml = 
                        ['Neoplasm', 'Drug', 'EIndex'].map(key => {
                            const item = counts[key];
                            const sourceKey = (key === 'EIndex' ? 'E-Index' : key); 
                            
                            return `
                                <button class="special-result-button" 
                                     data-source="${sourceKey}" 
                                     data-count="${item.count}"
                                     style="background-color: ${item.color}; border-color: ${item.color};">
                                    ${item.name} 
                                    <span class="button-count">(${item.count})</span>
                                </button>
                            `;
                        }).join('');
                } else {
                     specialButtonsHtml = `<span style="font-size: 0.9em; color: #888; font-style: italic;">
                                                本次搜索未找到任何腫瘤/中毒/外傷相關條目。
                                           </span>`;
                }

                document.getElementById('special-buttons-row').innerHTML = specialButtonsHtml;
                
                const MAX_RESULTS = 500;
                const filterName = filterMode === 'Special' ? '特殊列表 (腫瘤/外傷/中毒)' : 'CM/Tabular/PCS'; // 簡化數據範圍文字


                const filteredItems = [];
                const specialItems = [];
                const PRIORITY_SOURCES_SET = new Set(PRIORITY_SOURCES); 

                for (const result of fuseResults) {
                    const item = result.item;
                    const isSpecial = PRIORITY_SOURCES_SET.has(item.source);

                    if (isSpecial) {
                        // 儲存所有特殊結果
                        specialItems.push(item);
                    }

                    // 在 General 模式下，我們只顯示非特殊條目
                    if (filterMode === 'General' && !isSpecial) {
                        filteredItems.push(item);
                        // 只顯示前 MAX_RESULTS 條
                        if (filteredItems.length >= MAX_RESULTS) break;
                    }
                }
                currentSpecialResults = specialItems; // 更新特殊結果列表
                
                
                if (filterMode === 'Special') {
                    
                    // **更新 searchTimeInfo 元素內容 (特殊列表模式)**
                    searchTimeInfo.textContent = `| 特殊結果: ${currentSpecialResults.length} 條 (耗時 ${searchTime} ms)`;
                    
                    resultsDiv.innerHTML += `
                        <div id="detailed-list-container">
                            <p id="special-list-placeholder" style="text-align: center; padding: 30px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; font-weight: bold;">
                                請點擊上方的 **腫瘤/中毒/外傷** 按鈕，以展開並查看該類別的詳細結果清單。
                            </p>
                        </div>
                    `;
                } else {
                    // **更新 searchTimeInfo 元素內容 (一般模式)**
                    searchTimeInfo.textContent = `| 結果: ${filteredItems.length} 條 (前 ${MAX_RESULTS} 條, 數據範圍: ${filterName}, 耗時 ${searchTime} ms)`;


                    let listHtml = '<div id="detailed-list-container"><div id="detailed-results-list" class="result-container">';
                    
                    if (filteredItems.length === 0) {
                        listHtml += `<p style="color: #999; text-align: center; margin-top: 15px;">
                                        在當前篩選模式 (${filterName}) 下，找不到與 "${query}" 相關的代碼或描述。
                                     </p>`;
                    } else {
                        filteredItems.forEach(item => {
                            listHtml += renderGeneralIndexItem(item);
                        });
                    }
                    listHtml += '</div></div>';
                    resultsDiv.innerHTML += listHtml;
                }
                
                registerClickHandlers(); 

            } catch (e) {
                console.error('Search function error:', e);
                document.getElementById('results').innerHTML = `<p style="color: red; padding: 15px; border: 1px solid red; border-radius: 5px;">
                    <strong>致命錯誤：搜索執行中斷。</strong><br>
                    請將以下完整的錯誤信息複製給我，或檢查瀏覽器控制台 (F12)。<br>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: red; background-color: #ffe6e6; padding: 10px; margin-top: 10px; border-radius: 3px;">${e.message}</pre>
                </p>`;
            }
        }
        
        const debouncedSearch = debounce(searchCode, 300); 

        // --- 主載入和初始化 ---
        async function initialize() {
            try {
                // 由於 loadJson 已經被修改，這裡只需要確保成功即可
                const [cmIndex, tabularJson, pcsIndexData] = await Promise.all([
                    loadJson('data_cm_index.json', 'status-cm', 'CM Index'),
                    loadJson('data_tabular_index.json', 'status-tabular', 'Tabular List'),
                    loadJson('data_pcs_index.json', 'status-pcs', 'PCS Index')
                ]);

                const cmList = processIndexData(cmIndex);
                const pcsList = processIndexData(pcsIndexData);
                const tabularList = processTabularData(tabularJson); 
                
                fullIndex = [...cmList, ...pcsList, ...tabularList];

                fullIndex.forEach((item, index) => {
                    item.originalIndex = index;
                });

                if (cmIndex && tabularJson && pcsIndexData) {
                     isDataLoaded = true;
                     // 【優化點】：更新載入成功後的狀態顯示
                     const totalCount = fullIndex.length.toLocaleString('en-US'); // 增加千分位符
                     document.getElementById('initial-load-status').innerHTML = '數據已載入';
                     document.getElementById('initial-load-status').style.color = 'green';
                     document.getElementById('total-codes').textContent = `(總計: ${totalCount} 條)`;
                } else {
                     document.getElementById('initial-load-status').innerHTML = '數據載入失敗';
                     document.getElementById('initial-load-status').style.color = 'red';
                }
                
                searchInput.addEventListener('input', debouncedSearch);
                
                // V15 修正：刪除篩選器事件監聽
                /* document.querySelectorAll('#filter-container input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', debouncedSearch);
                }); */
                
                searchCode(); 

            } catch (e) {
                console.error('Initialization failed:', e);
                resultsDiv.innerHTML = `<p style="color: red;">應用初始化失敗。請檢查控制台錯誤。</p>`;
            }
        }

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchCode();
            }
        });

        initialize();
    </script>

</body>
</html>