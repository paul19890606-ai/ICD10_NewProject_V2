<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ICD-10-CM/PCSæœç´¢</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <style>
        /* ========================================================= */
        /* CSS æ¨£å¼ (V38 - è…«ç˜¤è¡¨æ ¼å„ªåŒ– - æ¬„å¯¬èª¿æ•´ 40% / 10%) */
        /* ========================================================= */
        body { font-family: Arial, sans-serif; padding: 20px; }
        
        /* è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .loading-dot { display: inline-block; width: 8px; height: 8px; background-color: orange; border-radius: 50%; margin-left: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* è®“æ¨™é ­æ‡¸æµ®çš„å®¹å™¨æ¨£å¼ */
        #sticky-header-container {
            position: sticky; 
            top: 0; 
            background-color: #ffffff; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            z-index: 100; 
            margin-bottom: 15px;
            padding-top: 10px; 
            padding-bottom: 5px; 
        }
        
        /* æ–°å¢ï¼šå®¹ç´æ¨™é¡Œ/ç‹€æ…‹å’Œæ§åˆ¶é …çš„æ–°å®¹å™¨ (å¯¦ç¾å·¦å³åˆ†é›¢) */
        #header-and-controls-row {
            display: flex;
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            justify-content: flex-start; /* ä¿æŒæ¨™é¡Œå’Œæ§åˆ¶é …ç·Šå¯†ç›¸é€£ */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            margin-bottom: 10px; /* èª¿æ•´èˆ‡ä¸‹æ–¹æœç´¢æ¡†çš„é–“è· */
            padding: 0 5px; /* å…§éƒ¨å¾®èª¿ */
        }
        
        /* æ–°å¢ï¼šæ¨™é¡Œå’Œç‹€æ…‹æŒ‡ç¤ºå™¨çš„ç¾¤çµ„ */
        #title-status-group {
            display: flex;
            align-items: center;
            flex-shrink: 0; /* ä¸å£“ç¸® */
            white-space: nowrap; /* ç¢ºä¿æ¨™é¡Œä¸æ›è¡Œ */
        }

        /* åŸå§‹ï¼šæ¨™é¡Œå®¹å™¨ï¼Œèª¿æ•´å…¶ä½ˆå±€ */
        #title-container { 
            display: flex; 
            align-items: flex-end; 
            margin-bottom: 0; /* ç§»é™¤èˆŠæœ‰çš„ margin-bottom */
        }
        /* æ ¸å¿ƒä¿®æ”¹: èª¿æ•´æ¨™é¡Œé–“è·ï¼Œä½¿å…¶å³å´ä¸å†æœ‰é–“è·ï¼Œè€Œå·¦å´æœ‰é–“è· */
        #title-container h2 { margin: 0; padding-left: 10px; } 
        
        /* ç‹€æ…‹åˆ—å®¹å™¨æ¨£å¼ */
        #status-bar-info { 
            font-size: 0.75em; 
            color: #555; 
            padding: 5px 10px; 
            border-left: none; 
            background-color: transparent; 
            border-radius: 4px; 
            flex-shrink: 0; /* é¿å…è¢«å£“ç¸® */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: flex; 
            align-items: center;
            justify-content: flex-start;
            padding-right: 0; /* ç§»é™¤å³å´å¤šé¤˜çš„ padding */
        }
        
        /* åœ“å½¢æŒ‡ç¤ºå™¨æ¨£å¼ */
        #load-status-indicator {
            display: inline-block; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background-color: #808080; /* åˆå§‹ç°è‰² */
            margin-right: 0; /* æ ¸å¿ƒä¿®æ”¹: ç§»é™¤æŒ‡ç¤ºç‡ˆå³å´é–“è·ï¼Œè®“ #title-container h2 çš„ padding-left ä¾†æä¾›é–“è· */
        }

        /* --- V32ï¼šä¸»æ§åˆ¶åˆ—å®¹å™¨æ¨£å¼ (ç§»å‹•åˆ°å³å´, å…§éƒ¨é å·¦å°é½Š) --- */
        #control-group-row { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; /* æ ¸å¿ƒä¿®æ”¹ï¼šè®“å…§å®¹é å·¦å°é½Š */
            gap: 10px; /* æ§åˆ¶çµ„ä»¶ä¹‹é–“çš„é–“è·ç•¥å¾®ç¸®å° */
            margin-bottom: 0; /* ç§»é™¤èˆŠæœ‰çš„ margin-bottom */
            padding: 0; /* ç§»é™¤èˆŠæœ‰çš„ padding */
            background-color: transparent; /* ç§»é™¤èƒŒæ™¯ */
            border: none; /* ç§»é™¤é‚Šæ¡† */
            overflow-x: auto; /* ç•¶çµ„ä»¶éå¤šæ™‚å…è¨±æ°´å¹³æ»¾å‹• */
            flex-shrink: 0; /* ç¢ºä¿çµ„ä»¶ä¸å£“ç¸® */
            flex-wrap: nowrap; 
            margin-left: 20px; /* åœ¨æ¨™é¡Œå’Œæ§åˆ¶é …ä¹‹é–“å¢åŠ é–“è· */
        }
        
        /* V32 ä¿®æ”¹ï¼šç¯©é¸å™¨å®¹å™¨æ¨£å¼ */
        #filter-container { 
            /* è®“å®ƒé¡¯ç¤º */
            display: flex !important; 
            align-items: center;
            gap: 10px; /* èª¿æ•´é–“è· */
            font-size: 0.95em; /* ç•¥å¾®ç¸®å°å­—é«” */
            padding: 0; 
            background-color: transparent; 
            border: none;
            /* ç¢ºä¿å…¶ä¸æœƒåœ¨æ§åˆ¶åˆ—ä¸­ä½”ç”¨éå¤šç©ºé–“ */
            flex-shrink: 0; 
        }
        #filter-container label { 
            margin-right: 0; 
            font-weight: 600; 
            color: #333; 
            display: inline-flex; 
            align-items: center; 
            white-space: nowrap;
        }
        #filter-container label:first-child { 
             /* ç§»é™¤ "çµæœç¯©é¸ï¼š" æ¨™ç±¤ */
             display: none;
        }
        #filter-container input[type="radio"] { 
            margin-right: 5px; 
            transform: scale(1.1); 
        }
        
        /* V30/V31ï¼šæŒ‰éˆ•ç¾¤çµ„ */
        #nav-buttons-group, #special-buttons-row {
             display: flex; 
             align-items: center; 
             gap: 10px;
             flex-shrink: 0; /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒè¢«å£“ç¸® */
        }
        
        /* æœç´¢åˆ—å®¹å™¨ */
        #search-bar-container { margin-bottom: 5px; margin-top: 10px; } /* æ¸›å°‘åº•éƒ¨é–“è· */
        #search-controls-row { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; /* ğŸ‘ˆ æ ¸å¿ƒä¿®æ”¹ï¼šè®“è¼¸å…¥æ¡†å’Œè¨ˆæ•¸è³‡è¨Šåˆ†æ•£ */
            gap: 15px; /* å¢åŠ é–“è· */
            flex-wrap: wrap; /* å…è¨±åœ¨æ‰‹æ©Ÿç­‰çª„è¢å¹•ä¸Šæ›è¡Œ */
        }
        
        /* è¼¸å…¥æ¡† */
        #search-input { 
            padding: 10px; 
            min-width: 200px; 
            max-width: 60%; /* ğŸ‘ˆ æ ¸å¿ƒä¿®æ”¹ï¼šå°‡å¯¬åº¦é™åˆ¶ç‚º 60% (V33) */
            width: 60%; /* ç¢ºä¿å…¶ä½”æ“š 60% å¯¬åº¦ (V33) */
            font-size: 16px; 
            border: 1px solid #ccc; 
            flex-grow: 0; /* ä¸å…è¨±ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            flex-shrink: 0; /* ä¸å£“ç¸® */
            /* æ ¸å¿ƒä¿®æ”¹ï¼šå°‡åœ“è§’è¨­å®šç‚º 100px é”åˆ°æœ€å¤§åœ“è§’æ•ˆæœ */
            border-radius: 100px;
        }
        
        .nav-button { 
            padding: 10px 15px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            border: none; 
            border-radius: 5px; 
            transition: background-color 0.3s, transform 0.1s; 
            height: 40px; 
            line-height: 20px; 
            flex-shrink: 0; 
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
        }
        #pcs-button { background-color: #008080; color: white; }
        #cm-button { background-color: #0056b3; color: white; }
        .nav-button:hover { transform: translateY(-1px); }
        
        /* ç‰¹æ®ŠæŒ‰éˆ•æ¨£å¼ */
        .special-result-button { 
            padding: 8px 15px; 
            font-size: 15px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 5px; 
            border: 2px solid; 
            background-color: #f7f7f7; 
            transition: all 0.2s; 
            flex-shrink: 0; 
            line-height: 1.2; 
            text-align: center; 
            height: 40px; 
            color: white; 
            position: relative; 
            white-space: nowrap;
        }
        .special-result-button:hover { 
            background-color: #fff; 
            transform: translateY(-1px); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            color: #333; 
        }

        /* åˆ—è¡¨å®¹å™¨ */
        .result-container { 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            background-color: #fff; 
            padding: 0;
            margin: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* åˆ—è¡¨è¡Œ */
        /* V36 æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ æ·¡ç¶ è‰²èƒŒæ™¯å’Œæ·±ç¶ è‰²é‚Šæ¡†ï¼Œä»¥ä¾¿è¦–è¦ºä¸Šå€åˆ†æ¯ä¸€æ¢çµæœ */
        .eindex-row {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            /* ç§»é™¤è™›ç·šåˆ†éš” */
            border-bottom: none; 
            /* æ–°å¢ï¼šæ·¡ç¶ è‰²èƒŒæ™¯ (ä½¿ç”¨ #F7FBF7) */
            background-color: #F7FBF7; 
            /* æ–°å¢ï¼šæ·±ç¶ è‰²å¯¦ç·šé‚Šæ¡† (ä½¿ç”¨ #EAEBEA - æ¥µæ·¡çš„ç°ç¶ è‰²) */
            border: 1px solid #EAEBEA; 
            border-radius: 5px;
            margin-bottom: 8px; /* å¢åŠ è¡Œä¹‹é–“çš„é–“éš” */
        }
        
        /* ç§»é™¤æœ€å¾Œä¸€è¡Œçš„åº•éƒ¨é‚Šæ¡†ï¼Œä½†å› ç‚ºç¾åœ¨æ¯è¡Œéƒ½æœ‰é–“éš”å’Œé‚Šæ¡†ï¼Œé€™å€‹æ¨£å¼å¯èƒ½ä¸å†éœ€è¦ */
        .eindex-row:last-child {
            border-bottom: 1px solid #EAEBEA; /* ä¿æŒæœ€å¾Œä¸€è¡Œä¹Ÿæœ‰é‚Šæ¡† */
        }

        /* ä»£ç¢¼æ¬„ä½ */
        .eindex-code-area {
            width: 140px !important; 
            min-width: 140px !important; 
            flex-shrink: 0 !important;
            padding-right: 15px;
            border-right: 3px solid #ccc; 
            text-align: right !important; 
        }
        
        /* ä»£ç¢¼æ¨£å¼ */
        .search-result-code {
            font-weight: bold;
            font-size: 1.1em;
            white-space: nowrap;
            display: inline-block;
            min-width: 80px; 
        }
        .search-result-code.is-clickable {
            text-decoration: none;
            border-bottom: 1px dotted; 
        }
        .search-result-code.is-clickable:hover {
            border-bottom-style: solid;
            color: #d32f2f !important;
        }
        
        /* å…§å®¹æ¬„ä½ */
        .eindex-content-area {
            flex-grow: 1; 
            padding-left: 15px;
            font-size: 0.95em;
            color: #333;
            line-height: 1.4;
        }
        .source { font-size: 0.8em; color: #666; margin-left: 10px; }
        .see-link { cursor: pointer; color: #d9534f; text-decoration: underline; margin-left: 5px; font-weight: bold; }

        /* ç‰¹æ®Šè¡¨æ ¼æ¨£å¼å®¹å™¨ï¼šå…è¨±æ°´å¹³æ»¾å‹• */
        .special-table-result { overflow-x: auto; max-width: 100%; }
        
        /* æ–°å¢ï¼šç”¨æ–¼åŒ…è£¹å›ºå®šè¡¨é ­çš„ Table æ¨£å¼ (ç¢ºä¿å¯¬åº¦ä¸€è‡´) */
        .neoplasm-header-table {
            width: 100%;
            min-width: 800px; 
            border-collapse: collapse;
            table-layout: fixed; /* ç¢ºä¿åˆ—å¯¬åº¦ä¸€è‡´ - V37 æ ¸å¿ƒä¿®æ”¹ */
            margin-bottom: 0;
            border-top: 2px solid #ccc; /* ä¿æŒé ‚éƒ¨é‚Šæ¡† */
            border-bottom: none !important;
        }
        
        /* V38 æ ¸å¿ƒä¿®æ”¹ 1: å®šç¾©æ¯å€‹åˆ—çš„å¯¬åº¦ (ç¬¬ä¸€æ¬„ 40%ï¼Œå…¶é¤˜ 10%) */
        .neoplasm-header-table colgroup col:nth-child(1),
        .neoplasm-body-table colgroup col:nth-child(1) { width: 40%; } /* Neoplasm/Drug/Substance Term */
        .neoplasm-header-table colgroup col:nth-child(2),
        .neoplasm-body-table colgroup col:nth-child(2) { width: 10%; } /* Malignant Primary / Accident */
        .neoplasm-header-table colgroup col:nth-child(3),
        .neoplasm-body-table colgroup col:nth-child(3) { width: 10%; } /* Malignant Secondary / Self-Harm */
        .neoplasm-header-table colgroup col:nth-child(4),
        .neoplasm-body-table colgroup col:nth-child(4) { width: 10%; } /* Ca in situ / Assault */
        .neoplasm-header-table colgroup col:nth-child(5),
        .neoplasm-body-table colgroup col:nth-child(5) { width: 10%; } /* Benign / Undetermined */
        .neoplasm-header-table colgroup col:nth-child(6),
        .neoplasm-body-table colgroup col:nth-child(6) { width: 10%; } /* Uncertain Behavior / Adverse Effect */
        .neoplasm-header-table colgroup col:nth-child(7),
        .neoplasm-body-table colgroup col:nth-child(7) { width: 10%; } /* Unspecified Behavior / Underdosing */
        
        /* V35 æ ¸å¿ƒä¿®æ”¹ 1: è¡¨æ ¼æ¨™é ­ç½®ä¸­ã€åŠ ç²—ã€å­—é«”æ”¾å¤§ */
        .neoplasm-table-header th { 
            padding: 10px 8px; /* å¢åŠ å‚ç›´å…§é‚Šè· */
            background-color: #e8e8e8; /* ç•¥å¾®èª¿æ•´èƒŒæ™¯è‰² */
            border-bottom: 3px solid #b0b0b0; /* è®“åˆ†éš”ç·šæ›´æ˜é¡¯ */
            text-align: center; /* æ ¸å¿ƒä¿®æ”¹ï¼šç½®ä¸­ */
            font-size: 1.05em; /* æ ¸å¿ƒä¿®æ”¹ï¼šå­—é«”ç•¥å¾®æ”¾å¤§ */
            color: #333; /* é è¨­å­—é«”é¡è‰² */
            font-weight: bold; /* ç¢ºä¿åŠ ç²— */
        }

        /* æ–°å¢ï¼šç”¨æ–¼åŒ…è£¹å¯æ»¾å‹•è¡¨æ ¼å…§å®¹çš„ Div (æ ¸å¿ƒï¼šå›ºå®šé«˜åº¦èˆ‡æ»¾å‹•) */
        .table-body-scroll {
            max-height: 600px; /* ç´„ 15 è¡Œçš„é«˜åº¦ */
            overflow-y: auto;
            border: 1px solid #ddd; /* å¢åŠ é‚Šæ¡†è®“æ»¾å‹•å€åŸŸå¯è¦‹ */
            border-top: none; /* é¿å…èˆ‡è¡¨é ­é‚Šæ¡†é‡ç–Š */
        }
        
        /* æ–°å¢ï¼šå…§å®¹è¡¨æ ¼æ¨£å¼ï¼Œç¢ºä¿ä½”æ»¿çˆ¶ç´šæ»¾å‹•å€åŸŸ */
        .neoplasm-body-table {
            width: 100%;
            min-width: 800px; /* ä¿æŒèˆ‡è¡¨é ­è¡¨æ ¼ç›¸åŒçš„æœ€å°å¯¬åº¦ */
            border-collapse: collapse;
            border-top: none !important; 
            table-layout: fixed; /* ç¢ºä¿åˆ—å¯¬åº¦ä¸€è‡´ - V37 æ ¸å¿ƒä¿®æ”¹ */
        }

        .neoplasm-row, .drug-row { 
            /* ç¢ºä¿ tr åœ¨æ–°çš„ body table ä¸­æœ‰é‚Šæ¡† */
            border-bottom: 1px solid #eee; 
            transition: background-color 0.1s; 
        }
        
        /* V35 æ ¸å¿ƒä¿®æ”¹ 3: è¡¨æ ¼è¡Œäº¤æ›¿åº•è‰² (é›™æ•¸è¡Œæ¨™æ·¡è‰²çš„åº•è‰²) - æ‡‰ç”¨åˆ°æ–°çš„ body table */
        .neoplasm-body-table tr:nth-child(even) {
            background-color: #F7FBF7; 
        }
        
        .neoplasm-row:hover, .drug-row:hover { background-color: #e0f0f0; } /* hover æ•ˆæœèª¿æ•´ */
        .neoplasm-term-col { 
            /* ç§»é™¤ width: 30% æ¨£å¼ï¼Œäº¤çµ¦ colgroup æ§åˆ¶ */
            padding: 8px; 
            font-weight: bold; 
            color: #333; 
            vertical-align: top; 
        }
        
        /* V35 æ ¸å¿ƒä¿®æ”¹ 2: ICD-10-CM ä»£ç¢¼å­—é«”æ”¾å¤§ */
        .neoplasm-code-col { 
            /* ç§»é™¤ width: 10% æ¨£å¼ï¼Œäº¤çµ¦ colgroup æ§åˆ¶ */
            text-align: center; 
            padding: 8px 4px; 
            font-size: 1em; /* èª¿æ•´ç‚º 1em */
            vertical-align: top; 
            color: #000; 
        }
        
        /* V34/V35 æ ¸å¿ƒï¼šè…«ç˜¤è¡Œç‚ºé¡å‹ä»£ç¢¼é¡è‰²å’ŒåŠ ç²— */
        .neoplasm-code-col strong {
            font-weight: bold;
            display: block; /* ç¢ºä¿ä»£ç¢¼ä½”æ»¿å–®å…ƒæ ¼ */
            color: #000; /* é è¨­é¡è‰²ï¼Œå°‡è¢«å°ˆå±¬é¡è‰²è¦†è“‹ */
            font-size: 1.15em; /* æ ¸å¿ƒä¿®æ”¹ï¼šå°‡ä»£ç¢¼çš„å­—é«”æ”¾å¤§ */
        }
        
        /* ICD-10-CM ä»£ç¢¼é¡è‰²å®šç¾© (èˆ‡ V34 ä¿æŒä¸€è‡´) */
        /* æƒ¡æ€§åŸç™¼ - æ·±ç´… */
        .code-malignant-primary { color: #8B0000 !important; font-weight: 700 !important; } 
        /* æƒ¡æ€§ç¹¼ç™¼ - æ·±æ©™ç´… */
        .code-malignant-secondary { color: #CC5500 !important; font-weight: 700 !important; }
        /* åŸä½ç™Œ - æ·±è— */
        .code-ca-in-situ { color: #00008B !important; font-weight: 700 !important; }
        /* è‰¯æ€§ - æ·±ç¶  */
        .code-benign { color: #006400 !important; font-weight: 700 !important; }
        /* ä¸ç¢ºå®š - æ·±ç´« */
        .code-uncertain { color: #4B0082 !important; font-weight: 700 !important; }
        /* æœªç‰¹æŒ‡ - æ·±ç°/é»‘ */
        .code-unspecified { color: #333333 !important; font-weight: 700 !important; }
        
        /* V37 æ–°å¢ï¼šå°‡é¡è‰²æ‡‰ç”¨æ–¼è¡¨é ­æ–‡å­— (èˆ‡ä»£ç¢¼é¡è‰²åŒæ­¥) */
        .neoplasm-header-table th.header-malignant-primary { color: #8B0000 !important; }
        .neoplasm-header-table th.header-malignant-secondary { color: #CC5500 !important; }
        .neoplasm-header-table th.header-ca-in-situ { color: #00008B !important; }
        .neoplasm-header-table th.header-benign { color: #006400 !important; }
        .neoplasm-header-table th.header-uncertain { color: #4B0082 !important; }
        .neoplasm-header-table th.header-unspecified { color: #333333 !important; }
        /* ========================================================= */
    </style>
</head>
<body>

    <div id="main-content">
        
        <div id="sticky-header-container"> 
            
            <div id="header-and-controls-row"> 

                <div id="title-status-group">
                    
                    <div id="status-bar-info">
                        <span id="load-status-indicator" title="æ•¸æ“šè¼‰å…¥ä¸­..."></span> 
                    </div>

                    <div id="title-container">
                        <h2>ICD-10-CM/PCS æœç´¢</h2>
                    </div>
                    
                </div>

                <div id="control-group-row">
                    
                    <div id="filter-container"> 
                        <label style="display: none;">çµæœç¯©é¸ï¼š</label>
                        
                        <label>
                            <input type="radio" name="result-filter" value="All" checked> 
                            ALL
                        </label>
                        
                        <label>
                            <input type="radio" name="result-filter" value="CM"> 
                            CM
                        </label>
                        
                        <label>
                            <input type="radio" name="result-filter" value="PCS"> 
                            PCS
                        </label>
                    </div>
                    
                    <button id="cm-button" class="nav-button" onclick="searchCode();">é‡æ–°æŸ¥è©¢</button>
                    
                    <div id="special-buttons-row">
                    </div>
                    
                    <button id="pcs-button" class="nav-button" onclick="window.location.href='search_pcs.html'">PCS å°ˆé–€æœç´¢</button>

                </div>
            </div> 
            
            <div id="search-bar-container">
                
                <div id="search-controls-row">
                    
                    <input type="text" id="search-input" placeholder="è¼¸å…¥ CM æˆ– PCS é—œéµå­— (ä¾‹å¦‚ï¼šLungã€FIBROSI LUNG)" autofocus>
                    
                    <div id="result-count-info" style="font-weight: bold; color: #333; white-space: nowrap;"></div> 
                    
                </div>
            </div>
        </div> 
        
        <div id="results">
            <p>æ•¸æ“šå·²è¼‰å…¥ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥é—œéµå­—æˆ–ä»£ç¢¼é€²è¡Œæ¨¡ç³Šæœç´¢ã€‚</p>
        </div>
    </div>

    <script>
        console.error = console.error.bind(console, 'APP ERROR:'); 

        let fullIndex = []; 
        let tabularData = {}; 
        let isDataLoaded = false;
        const resultsDiv = document.getElementById('results');
        const searchInput = document.getElementById('search-input');
        const loadIndicator = document.getElementById('load-status-indicator'); 
        
        let currentSpecialResults = []; 
        
        // ç‰¹æ®Šç´¢å¼•çš„ä¾†æºåˆ—è¡¨
        const PRIORITY_SOURCES = ["Neoplasm", "Drug", "E-Index"];
        const PRIORITY_SOURCES_SET = new Set(PRIORITY_SOURCES); 

        // Neoplasm å’Œ Drug è¡¨æ ¼çš„ä»£ç¢¼æ¬„ä½æ˜ å°„ (è‹±æ–‡æ¨™é ­)
        const NEOPLASM_COLUMNS_MAP = {
            'MalignantPrimary': 'Malignant Primary', 
            'MalignantSecondary': 'Malignant Secondary', 
            'CaInSitu': 'Ca in situ', 
            'Benign': 'Benign', 
            'UncertainBehavior': 'Uncertain Behavior', 
            'UnspecifiedBehavior': 'Unspecified Behavior'
        };
        const DRUG_COLUMNS = ['PoisoningAccident', 'PoisoningIntentionalSelfHarm', 'PoisoningAssault', 'PoisoningUndetermined', 'AdverseEffect', 'Underdosing'];

        // V34 æ ¸å¿ƒæ–°å¢ï¼šè¡Œç‚ºé¡å‹åˆ° CSS é¡åˆ¥çš„æ˜ å°„
        const BEHAVIOR_CLASS_MAP = {
            'col2': 'code-malignant-primary', // MalignantPrimary
            'col3': 'code-malignant-secondary', // MalignantSecondary
            'col4': 'code-ca-in-situ', // CaInSitu
            'col5': 'code-benign', // Benign
            'col6': 'code-uncertain', // UncertainBehavior
            'col7': 'code-unspecified' // UnspecifiedBehavior
        };
        
        // V37 æ–°å¢ï¼šè¡Œç‚ºé¡å‹åˆ°è¡¨é ­ CSS é¡åˆ¥çš„æ˜ å°„
        const HEADER_CLASS_MAP = {
            'MalignantPrimary': 'header-malignant-primary', 
            'MalignantSecondary': 'header-malignant-secondary', 
            'CaInSitu': 'header-ca-in-situ', 
            'Benign': 'header-benign', 
            'UncertainBehavior': 'header-uncertain', 
            'UnspecifiedBehavior': 'header-unspecified'
        };


        // --- è¼”åŠ©å‡½æ•¸ (ä¸è®Š) ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        
        async function loadJson(fileName) {
            try {
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(fileName + cacheBuster);
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status} (æª”æ¡ˆ: ${fileName})`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`è¼‰å…¥ ${fileName} å¤±æ•—:`, error);
                return null;
            }
        }
        
        function processIndexData(data) {
            if (!data) return [];
            return data.map(item => {
                const source = item.source || 'CM Index';
                const isSpecial = PRIORITY_SOURCES_SET.has(source);
                
                let type = '';
                if (isSpecial) {
                    type = 'CM_SPECIAL'; // è…«ç˜¤ã€è—¥ç‰©ã€å¤–å‚·
                } else if (source.includes('PCS')) {
                    type = 'PCS_INDEX'; // PCS ç´¢å¼•
                } else {
                    type = 'CM_INDEX'; // CM ä¸€èˆ¬ç´¢å¼•
                }

                return {
                    code: item.code || item.c, 
                    description: item.description || item.t, 
                    source: source, 
                    type: type, // æ ¸å¿ƒï¼šæ–°å¢æ˜ç¢ºçš„ type å±¬æ€§
                    see: item.see || null,       
                    seeAlso: item.seeAlso || null, 
                    use: item.use || null,
                    specialCodes: item.specialCodes || null 
                };
            });
        }

        function processTabularData(data) {
            tabularData = data || {}; 
            const list = [];
            if (!data) return [];
            
            for (const categoryCode in data) {
                const categoryEntry = data[categoryCode];
                // æ ¸å¿ƒï¼šæ–°å¢æ˜ç¢ºçš„ type å±¬æ€§ 'CM_TABULAR'
                list.push({ code: categoryCode, description: categoryEntry.term || categoryEntry.d, source: 'Tabular Category', type: 'CM_TABULAR' }); 
                const subEntries = categoryEntry.subs || categoryEntry.ch; 
                
                if (subEntries) {
                    for (const subCode in subEntries) {
                        const subEntry = subEntries[subCode];
                        // æ ¸å¿ƒï¼šæ–°å¢æ˜ç¢ºçš„ type å±¬æ€§ 'CM_TABULAR'
                        list.push({ code: subCode, description: subEntry.term || subEntry.d, source: 'Tabular Sub-Code', type: 'CM_TABULAR' });
                    }
                }
            }
            return list;
        }

        function getActiveFilters() {
            // V30 æ¢å¾© V29 é‚è¼¯
            const checkedRadio = document.querySelector('input[name="result-filter"]:checked');
            return checkedRadio ? [checkedRadio.value] : ['All']; 
        }
        
        function navigateToDetail(code) {
            const categoryCode = code.substring(0, 3); 
            // å°èˆªåˆ°æ–°çš„ Tabular è©³ç›®è¡¨é é¢ï¼Œä¸¦å‚³é 3 ä½æ•¸çš„ä»£ç¢¼
            window.location.href = `tabular_view.html?code=${categoryCode}`;
        }
        
        function navigateToSearch(term) {
            searchInput.value = term; 
            searchCode(); 
        }
        
        // --- é»æ“Šæ‘˜è¦æ–¹æ¡†å¾Œé¡¯ç¤ºç‰¹å®šæ¸…å–®çš„å‡½æ•¸ (å·²ä¿®æ”¹ç‚ºåˆ†é›¢è¡¨é ­/è¡¨èº«) ---
        function showSpecialList(source, count) {
            const listContainer = document.getElementById('detailed-list-container');
            
            if (!listContainer || !currentSpecialResults.length) {
                return; 
            }
            
            const targetResults = currentSpecialResults.filter(item => item.source.includes(source));
            
            const sourceMapName = {
                'Neoplasm': 'è…«ç˜¤ (Neoplasm)',
                'Drug': 'ä¸­æ¯’/è—¥ç‰© (Drug)',
                'E-Index': 'å¤–å‚·/å¤–éƒ¨åŸå›  (E-Index)'
            };
            const name = sourceMapName[source] || source;

            // 1. æº–å‚™è¡¨æ ¼æ¨™é ­ 
            let tableHeader = '';
            let headerRow = '';
            const isNeoplasmOrDrug = (source === 'Neoplasm' || source === 'Drug');

            // V38 æ ¸å¿ƒä¿®æ”¹ 2: æ›´æ–° colgroup ä¸­çš„å…§è¯æ¨£å¼
            let colgroupHtml = `
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                </colgroup>`;
            
            if (isNeoplasmOrDrug) {
                const columnsMap = source === 'Neoplasm' ? NEOPLASM_COLUMNS_MAP : {
                    'Accident': 'Accident', 
                    'SelfHarm': 'Self-Harm', 
                    'Assault': 'Assault', 
                    'Undetermined': 'Undetermined', 
                    'AdverseEffect': 'Adverse Effect', 
                    'Underdosing': 'Underdosing'
                };
                
                const headers = [source === 'Neoplasm' ? 'Neoplasm' : 'Drug/Substance', ...Object.values(columnsMap)];
                
                // V37 æ ¸å¿ƒä¿®æ”¹ 1: æº–å‚™è¡¨é ­è¡Œ (<th> å…§æ–°å¢é¡è‰²é¡åˆ¥)
                const headerKeys = [source === 'Neoplasm' ? 'Term' : 'DrugTerm', ...Object.keys(columnsMap)];
                
                headerRow = `<tr class="neoplasm-table-header">`;
                headerKeys.forEach((key, index) => {
                    let headerText = headers[index];
                    let headerClass = '';

                    if (source === 'Neoplasm' && index > 0) {
                        // key æ˜¯ MalignantPrimary, MalignantSecondary, ...
                        headerClass = HEADER_CLASS_MAP[key] || '';
                    }
                    
                    headerRow += `<th${headerClass ? ` class="${headerClass}"` : ''}>${headerText}</th>`;
                });
                headerRow += `</tr>`;
                
            } else {
                tableHeader = `<thead>
                                    <tr class="neoplasm-table-header">
                                        <th style="width: 30%;">E-Index Term</th>
                                        <th style="width: 70%;" colspan="6">Code/Reference</th>
                                    </tr>
                                </thead>`;
                colgroupHtml = ''; // E-Index ä¸ä½¿ç”¨ colgroup
            }


            // 2. æº–å‚™ HTML çµæ§‹
            let listHtml = `
                <h3 style="margin-top: 20px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px;">
                    ${name} è©³ç´°æ¸…å–® (${targetResults.length} æ¢çµæœ)
                </h3>
                <div id="detailed-results-list" class="result-container">
            `;
            
            if (targetResults.length === 0) {
                listHtml += `<p style="color: #999; text-align: center; margin-top: 15px;">
                                æ‰¾ä¸åˆ°èˆ‡ ${name} ç›¸é—œçš„çµæœã€‚
                             </p>`;
            } else {
                 if (isNeoplasmOrDrug) {
                    
                    // æ ¸å¿ƒä¿®æ”¹ 1: æº–å‚™å…§å®¹è¡Œ (åªæœ‰ <tbody> å…§å®¹)
                    let bodyContent = '';
                    targetResults.forEach(item => {
                        bodyContent += renderStandardSpecialTable(item); // Renders <tr>
                    });

                    // æ ¸å¿ƒä¿®æ”¹ 2: çµ„è£æ–°çš„ HTML çµæ§‹ï¼Œåˆ†é›¢è¡¨é ­å’Œå…§å®¹
                    listHtml += `<div class="special-table-result">
                                 <table class="neoplasm-header-table">
                                     ${colgroupHtml} 
                                     <thead>
                                         ${headerRow}
                                     </thead>
                                 </table>
                                 
                                 <div class="table-body-scroll">
                                     <table class="neoplasm-body-table">
                                         ${colgroupHtml} 
                                         <tbody>
                                             ${bodyContent}
                                         </tbody>
                                     </table>
                                 </div>
                             </div>`;

                } else {
                    // E-Index æ²¿ç”¨èˆŠçš„æ¸²æŸ“æ–¹å¼
                    listHtml += `<div class="special-table-result">
                                 <table style="width: 100%; border-collapse: collapse; border-top: 2px solid #ccc;">
                                    ${tableHeader}
                                    <tbody>`;
                    
                    targetResults.forEach(item => {
                        listHtml += renderEIndexItem(item); 
                    });
                    
                    listHtml += `</tbody></table></div>`;
                }
            }
            
            listHtml += '</div>';

            // 3. æ›¿æ›å®¹å™¨å…§å®¹
            listContainer.innerHTML = listHtml;
            
            // 4. è¨»å†Šæ–°çš„é»æ“Šäº‹ä»¶
            registerClickHandlers(); 
        }
        
        // --- é»æ“Šäº‹ä»¶è¨»å†Šå‡½æ•¸ (ä¸è®Š) ---
        function registerClickHandlers() {
            document.querySelectorAll('#results .search-result-code.is-clickable').forEach(span => {
                // ç¢ºä¿åªé‡å°å¯é»æ“Šçš„ <a> æˆ– <span> ç¶å®š
                 span.onclick = (e) => {
                    e.preventDefault(); // é˜»æ­¢é»˜èªè¡Œç‚º
                    navigateToDetail(span.dataset.code);
                 };
            });
            
            document.querySelectorAll('#results .see-link').forEach(span => {
                span.onclick = (e) => {
                    const term = e.target.dataset.searchTerm;
                    if (term) navigateToSearch(term);
                };
            });

            document.querySelectorAll('.special-result-button').forEach(button => {
                 button.onclick = (e) => {
                    const target = e.currentTarget; 
                    const source = target.dataset.source;
                    showSpecialList(source, '0');
                };
            });
        }
        
        // --- V34/V35/V37 æ ¸å¿ƒä¿®æ”¹ï¼šæ¸²æŸ“å‡½æ•¸ï¼šç‰¹æ®Šåˆ—è¡¨ (å¤šæ¬„ä½è¡¨æ ¼ - Neoplasm & Drug) ---
        function renderStandardSpecialTable(item) {
            const rowClass = item.source.includes('Drug') ? 'drug-row' : item.source.includes('Neoplasm') ? 'neoplasm-row' : '';
            const isNeoplasm = item.source.includes('Neoplasm');
            const isDrug = item.source.includes('Drug');
            let termCell = item.description;

            let rowContent = '';
            // 1. ç´¢å¼•è©æ¬„ä½
            rowContent += `<td class="neoplasm-term-col">${termCell} <span class="source">[${item.source}]</span></td>`;

            // 2. è™•ç†å¤šæ¬„ä½ä»£ç¢¼
            if (isNeoplasm || isDrug) {
                const columns = isNeoplasm ? Object.keys(NEOPLASM_COLUMNS_MAP) : DRUG_COLUMNS;
                const codes = item.specialCodes || {};
                
                let colNum = 1; 
                
                const codeCellsHtml = columns.map(colKey => {
                    colNum++; 
                    const colKeyName = `col${colNum}`; // ä¾‹å¦‚ï¼šcol2, col3, ...
                    const code = codes[colKeyName] || '-'; 
                    
                    const isCMCode = code.match(/^[A-TV-Z]\d{2}/i);
                    
                    const codePrefix = code.substring(0, 3);
                    const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
                    
                    let cellContent = code;
                    let codeHtml = code;
                    
                    // V34 æ ¸å¿ƒä¿®æ”¹ï¼šç²å–è¡Œç‚ºé¡å‹å°æ‡‰çš„ CSS é¡åˆ¥
                    const behaviorClass = isNeoplasm ? BEHAVIOR_CLASS_MAP[colKeyName] || '' : '';
                    const extraClasses = isNeoplasm ? `class="${behaviorClass}"` : '';
                    
                    if (code !== '-') {
                        if (isTabularLink) {
                            // æ‡‰ç”¨å¼·çƒˆçš„ <strong> æ¨™ç±¤å’Œ CSS é¡åˆ¥
                            codeHtml = `<a href="#" onclick="navigateToDetail('${code}'); return false;" class="is-clickable" style="text-decoration: none; color: inherit;" title="é»æ“ŠæŸ¥çœ‹ ${codePrefix}.XX è©³ç›®è¡¨ (Tabular List) è³‡è¨Š"><strong ${extraClasses}>${code}</strong></a>`;
                        } else {
                            // æ‡‰ç”¨å¼·çƒˆçš„ <strong> æ¨™ç±¤å’Œ CSS é¡åˆ¥
                            codeHtml = `<strong ${extraClasses}>${code}</strong>`;
                        }
                    } else {
                        codeHtml = `<span>${code}</span>`; // '-' ä¸åŠ ç²—
                    }

                    return `<td class="neoplasm-code-col">${codeHtml}</td>`;
                }).join('');
                
                rowContent += codeCellsHtml;
            }

            // 3. è¿”å›å®Œæ•´çš„è¡¨æ ¼è¡Œ HTML
            return `<tr class="${rowClass}">${rowContent}</tr>`;
        }

        // --- æ¸²æŸ“å‡½æ•¸ï¼šE-Index (ç°¡æ½”åˆ—è¡¨ - å¤–å‚·/å¤–éƒ¨åŸå› ) (ä¸è®Š) ---
        function renderEIndexItem(item) {
            const rowClass = item.source.includes('E-Index') ? 'eindex-row' : '';
            let code = item.code || '-';
            let mainContentHtml = item.description;

            // è™•ç† SEE/USE/SEE ALSO é‚è¼¯ 
            let refLinkHtml = '';
            if (item.see || item.use || item.seeAlso) {
                if (item.see) {
                    refLinkHtml = `<span style="font-style: italic;">SEE:</span> <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
                } else if (item.use) {
                    refLinkHtml = `<span style="font-style: italic;">USE:</span> <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
                } else if (item.seeAlso) {
                    refLinkHtml = `<span style="font-style: italic;">SEE ALSO:</span> <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
                }
                
                mainContentHtml += `<span style="margin-left: 15px;"></span>` + refLinkHtml;

                if (!item.code) {
                     code = '-'; 
                }
            }

            // ä»£ç¢¼é¡è‰²é‚è¼¯
            const codeColor = code.startsWith('Y') ? '#d9534f' : '#0096d6';
            
            // æª¢æŸ¥æ˜¯å¦ç‚º CM ä»£ç¢¼
            const isCMCode = code.match(/^[A-TV-Z]\d{2}/i);
            
            const codePrefix = code.substring(0, 3);
            const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
            const clickableClass = isTabularLink ? 'is-clickable' : '';
            
            let codeHtml = '-';
            if (code !== '-') {
                if (isTabularLink) {
                     codeHtml = `<a href="#" onclick="navigateToDetail('${code}'); return false;" class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor};" title="é»æ“ŠæŸ¥çœ‹ ${codePrefix}.XX è©³ç›®è¡¨ (Tabular List) è³‡è¨Š">${code}</a>`;
            } else {
                     codeHtml = `<span class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor};">${code}</span>`;
                }
            }


            return `
                <div class="${rowClass}">
                    <div class="eindex-code-area" style="border-right-color: ${codeColor}">
                        ${codeHtml}
                    </div>
                    <div class="eindex-content-area">
                        ${mainContentHtml}
                        <span class="source">[${item.source}]</span>
                    </div>
                </div>
            `;
        }
        
        // --- æ¸²æŸ“å‡½æ•¸ï¼šä¸€èˆ¬ç´¢å¼•é …ç›® (CM Index, Tabular List, PCS Index) ---
        function renderGeneralIndexItem(item) {
            // V36 ä¿®æ”¹ï¼šæ‰€æœ‰ä¸€èˆ¬çµæœè¡Œéƒ½ä½¿ç”¨ç›¸åŒçš„æ¨£å¼é¡åˆ¥
            const rowClass = 'eindex-row'; 
            let code = item.code || '-';
            let mainContentHtml = item.description;

            // è™•ç† SEE/USE/SEE ALSO é‚è¼¯
            let refLinkHtml = '';
            if (item.see || item.use || item.seeAlso) {
                if (item.see) {
                    refLinkHtml = `<span style="font-style: italic;">SEE:</span> <span class="see-link" data-search-term="${item.see}">${item.see}</span>`;
                } else if (item.use) {
                    refLinkHtml = `<span style="font-style: italic;">USE:</span> <span class="see-link" data-search-term="${item.use}">${item.use}</span>`;
                } else if (item.seeAlso) {
                    refLinkHtml = `<span style="font-style: italic;">SEE ALSO:</span> <span class="see-link" data-search-term="${item.seeAlso}">${item.seeAlso}</span>`;
                }
                
                mainContentHtml += `<span style="margin-left: 15px;"></span>` + refLinkHtml;

                if (!item.code) {
                     code = '-'; 
                }
            }

            // ä½¿ç”¨ item.type åˆ¤æ–·é¡è‰²
            const isPCS = item.type === 'PCS_INDEX';
            const isTabular = item.type === 'CM_TABULAR';
            const isCMIndex = item.type === 'CM_INDEX';

            const codeColor = isPCS ? '#008080' : isTabular ? '#0056b3' : isCMIndex ? '#0056b3' : '#333';
            const separatorColor = codeColor;
            
            // Tabular Link åƒ…é©ç”¨æ–¼ CM æ•¸æ“š
            const isCMData = isTabular || isCMIndex; 
            const isCMCode = isCMData && code.match(/^[A-TV-Z]\d{2}/i);

            const codePrefix = code.substring(0, 3);
            const isTabularLink = isCMCode && code.length >= 3 && codePrefix in tabularData;
            const clickableClass = isTabularLink ? 'is-clickable' : '';
            
            let codeHtml = '-';
            if (code !== '-') {
                if (isTabularLink) {
                     // ç¢ºä¿é€™è£¡ä½¿ç”¨ navigateToDetail å‡½æ•¸
                     codeHtml = `<a href="#" onclick="navigateToDetail('${code}'); return false;" class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor}; margin-right: 0;" title="é»æ“ŠæŸ¥çœ‹ ${codePrefix}.XX è©³ç›®è¡¨ (Tabular List) è³‡è¨Š">${code}</a>`;
            } else {
                     codeHtml = `<span class="search-result-code ${clickableClass}" data-code="${code}" style="color: ${codeColor}; margin-right: 0;">${code}</span>`;
                }
            }


            return `
                <div class="${rowClass}">
                    <div class="eindex-code-area" style="border-right-color: ${separatorColor}">
                        ${codeHtml}
                    </div>
                    <div class="eindex-content-area">
                        ${mainContentHtml}
                        <span class="source">[${item.source}]</span>
                    </div>
                </div>
            `;
        }

        // --- æ¸²æŸ“å‡½æ•¸ï¼šæ¸²æŸ“ç‰¹æ®ŠæŒ‰éˆ• (V31 - ä¿®æ”¹æŒ‰éˆ•åç¨±) ---
        function renderSpecialButtons() {
            const specialButtonsHtml = 
                [
                    { key: 'Neoplasm', name: 'è…«ç˜¤', color: '#9932cc', sourceKey: 'Neoplasm' },
                    { key: 'Drug', name: 'ä¸­æ¯’/è—¥ç‰©', color: '#ff7b00', sourceKey: 'Drug' },
                    // V31: å°‡ 'å¤–å‚·/å¤–éƒ¨åŸå› ' æ”¹ç‚º 'å¤–å‚·/å¤–å› '
                    { key: 'EIndex', name: 'å¤–å‚·/å¤–å› ', color: '#0096d6', sourceKey: 'E-Index' }
                ].map(item => {
                    // ç”±æ–¼æˆ‘å€‘èª¿æ•´äº†ä½ˆå±€ï¼Œé€™è£¡ä¸å†æ¸²æŸ“è¨ˆæ•¸ï¼Œåªæ¸²æŸ“æŒ‰éˆ•æœ¬èº«
                    return `
                        <button class="special-result-button" 
                             data-source="${item.sourceKey}" 
                             data-count="0"
                             style="background-color: ${item.color}; border-color: ${item.color};">
                            ${item.name} 
                        </button>
                    `;
                }).join('');
            
            document.getElementById('special-buttons-row').innerHTML = specialButtonsHtml;
            // ç¢ºä¿æŒ‰éˆ•é»æ“Šäº‹ä»¶è¢«è¨»å†Š
            registerClickHandlers();
        }


        // --- æœç´¢ä¸»å‡½æ•¸ (ä¸è®Š) ---
        function searchCode() {
             try {
                const query = searchInput.value.trim();
                resultsDiv.innerHTML = '';
                currentSpecialResults = []; 
                
                const activeFilters = getActiveFilters();
                const currentFilter = activeFilters[0]; // All, CM, or PCS
                const resultCountInfo = document.getElementById('result-count-info'); // ç²å–è¨ˆæ•¸å®¹å™¨

                if (!isDataLoaded || query.length === 0 || query.length < 2) {
                    if (!isDataLoaded) {
                        resultsDiv.innerHTML = '<p style="color: red;">æ•¸æ“šä»åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ã€‚</p>';
                    } else if (query.length === 0) {
                        resultsDiv.innerHTML = '<p>è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥é—œéµå­—æˆ–ä»£ç¢¼é€²è¡Œæ¨¡ç³Šæœç´¢ã€‚</p>';
                    } else if (query.length > 0 && query.length < 2) {
                        resultsDiv.innerHTML = '<p>è«‹è¼¸å…¥è‡³å°‘å…©å€‹å­—ç¬¦é€²è¡Œæœç´¢ã€‚</p>';
                    }
                    if (resultCountInfo) {
                       resultCountInfo.innerHTML = '';
                    }
                    renderSpecialButtons(); // ä¿æŒæŒ‰éˆ•å¸¸é§
                    return;
                }

                // (Fuse æœç´¢ã€åˆ†æ•¸èª¿æ•´å’Œæ’åºé‚è¼¯ä¸è®Š)
                const startTime = performance.now(); 
                const fuseOptions = {keys: ['code', 'description', 'see', 'seeAlso', 'use'], threshold: 0.35, includeScore: true, ignoreLocation: true, distance: 100};
                const fuse = new Fuse(fullIndex, fuseOptions); 
                let fuseResults = fuse.search(query); 
                const queryLower = query.toLowerCase();

                // æ’åºé‚è¼¯ (ä¿æŒ V29 è¤‡é›œçš„æ’åºé‚è¼¯)
                fuseResults = fuseResults.map(result => {
                    const item = result.item;
                    let score = result.score;
                    let scoreAdjustment = 0;
                    
                    // æª¢æŸ¥ç‰¹æ®Šç´¢å¼•
                    if (PRIORITY_SOURCES_SET.has(item.source)) scoreAdjustment += 0.08; 
                    
                    // æª¢æŸ¥ä»£ç¢¼å®Œå…¨åŒ¹é…æˆ–å‰ç¶´åŒ¹é… (V29 é‚è¼¯)
                    if (item.code && item.code.trim().toLowerCase() === queryLower) {
                        scoreAdjustment += 0.2; 
                    } else if (item.code && item.code.trim().toLowerCase().startsWith(queryLower)) {
                        scoreAdjustment += 0.1; 
                    }
                    
                    // æª¢æŸ¥æè¿°é–‹é ­åŒ¹é… (V29 é‚è¼¯)
                    const descriptionLower = item.description.toLowerCase();
                    const queryIndex = descriptionLower.indexOf(queryLower);
                    if (queryIndex !== -1) {
                         const nextCharIndex = queryIndex + queryLower.length;
                         const nextChar = descriptionLower.charAt(nextCharIndex);
                         
                         if (queryIndex === 0 && (nextChar === '(' || nextChar === ',' || nextChar === '-')) {
                            scoreAdjustment += 0.15; 
                         }
                    }

                    result.adjustedScore = Math.max(0, score - scoreAdjustment);
                    return result;
                });
                fuseResults.sort((a, b) => a.adjustedScore - b.adjustedScore);


                const endTime = performance.now(); 
                const searchTime = (endTime - startTime).toFixed(2);
                
                if (loadIndicator) { loadIndicator.title = `æœç´¢å®Œæˆ (è€—æ™‚ ${searchTime} ms)`; }

                renderSpecialButtons(); // é‡æ–°æ¸²æŸ“æŒ‰éˆ• 

                const MAX_RESULTS = 500;
                const generalItems = []; 
                const specialItems = [];
                

                for (const result of fuseResults) { 
                    const item = result.item;
                    const itemType = item.type;
                    
                    let passFilter = false;
                    
                    if (itemType === 'CM_SPECIAL') {
                        specialItems.push(item);
                    }

                    // æ ¸å¿ƒç¯©é¸é‚è¼¯ (V29 ä¿æŒä¸è®Š)
                    if (currentFilter === 'All') {
                        if (itemType !== 'CM_SPECIAL') { passFilter = true; }
                    } else if (currentFilter === 'CM') {
                        if (itemType === 'CM_INDEX' || itemType === 'CM_TABULAR') { passFilter = true; }
                    } else if (currentFilter === 'PCS') {
                        if (itemType === 'PCS_INDEX') { passFilter = true; }
                    }
                    
                    if (passFilter) {
                        generalItems.push(item);
                        if (generalItems.length >= MAX_RESULTS) break;
                    }
                }
                currentSpecialResults = specialItems; 
                
                // V29 é‚è¼¯ï¼šæ›´æ–°çµæœè¨ˆæ•¸é¡¯ç¤º
                if (resultCountInfo) {
                    // V31: æ›´æ–°ç¯©é¸åç¨±é¡¯ç¤º
                    let filterDisplayName = currentFilter;
                    if (currentFilter === 'All') {
                        filterDisplayName = 'ALL';
                    }
                    if (generalItems.length > 0) {
                        resultCountInfo.innerHTML = `âœ… <strong>æ‰¾åˆ° ${generalItems.length} æ¢ç¬¦åˆ <span style="color: #0056b3; text-decoration: underline;">${filterDisplayName}</span> ç¯©é¸æ¨¡å¼çš„çµæœã€‚</strong>`;
                    } else {
                        resultCountInfo.innerHTML = 'âš ï¸ <strong>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä¸€èˆ¬çµæœã€‚</strong>';
                    }
                }
                
                // æ¸²æŸ“çµæœæ¸…å–®
                resultsDiv.innerHTML = ''; 
                
                // V36 ä¿®æ”¹ï¼šç§»é™¤ result-container çš„é‚Šæ¡†ï¼Œè®“æ¯ä¸€è¡Œçš„é‚Šæ¡†é¡¯ç¤ºå‡ºä¾†
                let listHtml = '<div id="detailed-list-container"><div id="detailed-results-list" style="border: none; box-shadow: none; background-color: transparent; padding: 0;">';
                
                if (generalItems.length === 0 && specialItems.length === 0) {
                     listHtml += `<p style="color: #999; text-align: center; margin-top: 15px; padding: 20px;">
                                    æ‰¾ä¸åˆ°èˆ‡ "${query}" ç›¸é—œçš„ä»£ç¢¼æˆ–æè¿°ã€‚
                                 </p>`;
                } else if (generalItems.length === 0 && specialItems.length > 0) {
                    listHtml += `<p style="text-align: center; padding: 30px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; font-weight: bold;">
                                    æ‰¾ä¸åˆ°ç¬¦åˆ **${currentFilter}** æ¨¡å¼çš„çµæœã€‚<br>
                                    ä½†æª¢æ¸¬åˆ° ${specialItems.length} æ¢ç‰¹æ®Šç´¢å¼•çµæœã€‚è«‹é»æ“Šä¸Šæ–¹çš„ç‰¹æ®Šç´¢å¼•æŒ‰éˆ•æŸ¥çœ‹ã€‚
                                 </p>`;
                } else {
                    generalItems.forEach(item => {
                        listHtml += renderGeneralIndexItem(item);
                    });
                }
                listHtml += '</div></div>';
                resultsDiv.innerHTML += listHtml;
                
                // è¨»å†Šé»æ“Šäº‹ä»¶
                registerClickHandlers(); 

            } catch (e) {
                console.error('Search function error:', e);
                document.getElementById('results').innerHTML = `<p style="color: red; padding: 15px; border: 1px solid red; border-radius: 5px;">
                    <strong>è‡´å‘½éŒ¯èª¤ï¼šæœç´¢åŸ·è¡Œä¸­æ–·ã€‚</strong><br>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: red; background-color: #ffe6e6; padding: 10px; margin-top: 10px; border-radius: 3px;">${e.message}</pre>
                </p>`;
            }
        }
            
        const debouncedSearch = debounce(searchCode, 300); 

        // --- ä¸»è¼‰å…¥å’Œåˆå§‹åŒ– (ä¸è®Š) ---
        async function initialize() {
            try {
                if (loadIndicator) { loadIndicator.style.backgroundColor = 'orange'; loadIndicator.title = 'æ•¸æ“šè¼‰å…¥ä¸­...'; }
                
                // è¼‰å…¥ JSON æ•¸æ“š (ä½¿ç”¨ V29 é‚è¼¯)
                const [cmIndex, tabularJson, pcsIndexData] = await Promise.all([
                    loadJson('data_cm_index.json'),
                    loadJson('data_tabular_index.json'),
                    loadJson('data_pcs_index.json')
                ]);

                if (!cmIndex || !tabularJson || !pcsIndexData) {
                    throw new Error("åˆå§‹åŒ–å¤±æ•—ï¼šéƒ¨åˆ†æˆ–å…¨éƒ¨æ•¸æ“šæª”æ¡ˆï¼ˆJSONï¼‰ç„¡æ³•è¼‰å…¥ã€‚è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘å’Œä¼ºæœå™¨é…ç½®ã€‚");
                }
                
                const cmList = processIndexData(cmIndex);
                const pcsList = processIndexData(pcsIndexData);
                const tabularList = processTabularData(tabularJson); 
                
                fullIndex = [...cmList, ...pcsList, ...tabularList];
                
                fullIndex.forEach((item, index) => { item.originalIndex = index; });

                isDataLoaded = true;
                
                if (loadIndicator) {
                     loadIndicator.style.backgroundColor = '#28a745'; 
                     loadIndicator.title = `ICD-10 æ•¸æ“šè¼‰å…¥å®Œæˆ (ç¸½è¨ˆ ${fullIndex.length.toLocaleString()} æ¢)`;
                }

                // è¨»å†Šäº‹ä»¶
                renderSpecialButtons(); // æ¸²æŸ“æŒ‰éˆ•
                searchInput.addEventListener('input', debouncedSearch);
                // V30 æ¢å¾© Radio Button çš„äº‹ä»¶ç›£è½
                document.querySelectorAll('input[name="result-filter"]').forEach(radio => {
                    radio.addEventListener('change', searchCode); 
                });

                searchCode(); 

            } catch (e) {
                console.error('Initialization failed:', e);
                if (loadIndicator) { loadIndicator.style.backgroundColor = '#dc3545'; loadIndicator.title = 'æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—'; }
                resultsDiv.innerHTML = `<p style="color: red; padding: 15px; border: 1px solid red; border-radius: 5px;">
                    <strong>è‡´å‘½éŒ¯èª¤ï¼šæ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ã€‚</strong><br>
                    è«‹ç¢ºèªæ‚¨çš„ä¸‰å€‹ JSON æ•¸æ“šæª”æ¡ˆ (data_cm_index.json, data_tabular_index.json, data_pcs_index.json) æ˜¯å¦å­˜åœ¨æ–¼ç›¸åŒç›®éŒ„ä¸­ä¸”å¯è®€å–ã€‚<br>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: red; background-color: #ffe6e6; padding: 10px; margin-top: 10px; border-radius: 3px;">${e.message}</pre>
                </p>`;
            }
        }

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchCode();
            }
        });

        initialize();
    </script>

</body>
</html>