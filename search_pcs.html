<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ICD-10-PCS æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: #f5f5f5;
      color: #111827;
      /* ç¢ºä¿ body å…·å‚™ç›¸å°å®šä½ï¼Œè®“æµ®å‹•é€£çµå¯ä»¥ä¾é™„ */
    }

    .app {
      max-width: 1400px; /* [ä¿®æ­£] èª¿æ•´æœ€å¤§å¯¬åº¦ï¼Œè®“å±…ä¸­æ•ˆæœæ›´æ˜é¡¯ */
      margin: 3px;
      padding: 24px 20px 40px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }
    
    /* [é‡è¦ä¿®æ­£] è¿”å›é€£çµçš„æµ®å‹•æ¨£å¼ */
    .floating-back-link {
        /* æ”¹ç‚º Fixed å®šä½ï¼Œç¢ºä¿å®ƒå§‹çµ‚æ‡¸æµ®åœ¨è¦–çª—å³ä¸Šè§’ */
        position: fixed; 
        top: 20px; /* è·é›¢è¦–çª—é ‚éƒ¨ 20px */
        right: 20px; /* è·é›¢è¦–çª—å³å´ 20px */
        z-index: 1000; /* ç¢ºä¿å®ƒåœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸Š */
        
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px; /* å¢å¤§ paddingï¼Œæ›´åƒæŒ‰éˆ• */
        border-radius: 8px; /* èª¿æ•´åœ“è§’ */
        background: #4f46e5; /* è—è‰²èƒŒæ™¯ */
        color: #ffffff; /* ç™½è‰²æ–‡å­— */
        text-decoration: none;
        font-size: 0.9rem; 
        font-weight: 600;
        border: 2px solid #4f46e5; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* å¢åŠ é™°å½±ä½¿å…¶æ›´çªå‡º */
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    .floating-back-link:hover {
        background: #4338ca; /* Hover æ™‚é¡è‰²è®Šæ·± */
        border-color: #4338ca;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    .floating-back-link svg {
        width: 16px;
        height: 16px;
        fill: #ffffff; /* SVG åœ–æ¨™é¡è‰²æ”¹ç‚ºç™½è‰² */
    }
    
    /* æ–°å¢ï¼šæ¸…é™¤å·²é¸æ“‡ä»£ç¢¼çš„æµ®å‹•æŒ‰éˆ•æ¨£å¼ */
    .floating-clear-btn {
        position: fixed; 
        top: 70px; /* ä½æ–¼è¿”å›æŒ‰éˆ•ä¸‹æ–¹ (20px + é€£çµé«˜åº¦ ~36px + é–“éš” 14px) */
        right: 20px; 
        z-index: 1000;
        
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        background: #dc2626; /* ç´…è‰²èƒŒæ™¯ */
        color: #ffffff;
        text-decoration: none;
        font-size: 0.9rem; 
        font-weight: 600;
        border: 2px solid #dc2626; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s, box-shadow 0.2s;
        cursor: pointer;
        margin: 0;
        line-height: normal;
    }
    .floating-clear-btn:hover {
        background: #b91c1c; /* Hover æ™‚é¡è‰²è®Šæ·± */
        border-color: #b91c1c;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    .floating-clear-btn:disabled {
        background: #9ca3af;
        border-color: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
    }

    
    /* [ä¿®æ­£] ç¢ºä¿ app å€å¡Šä¸æœƒè¢« floating-back-link æ“‹ä½æ¨™é¡Œï¼Œä¸¦å¯¦ç¾å±…ä¸­ */
    @media (min-width: 640px) {
        .app {
            /* é ç•™å³å´ç©ºé–“çµ¦æµ®å‹•æŒ‰éˆ•ï¼Œé˜²æ­¢æŒ‰éˆ•é®æ“‹å…§å®¹ */
            padding-right: 120px; 
            /* ä¿®æ­£ï¼šè¨­ç½®å·¦å³ margin ç‚º autoï¼Œå¯¦ç¾å±…ä¸­ */
            margin: 20px auto; 
        }
    }

    /* æ–°å¢ï¼šæ¨™é¡Œå’Œç‹€æ…‹çš„å®¹å™¨ */
    .header-row {
      display: flex;
      justify-content: space-between; /* <-- è®“æ¨™é¡Œå’Œç‹€æ…‹å€å¡Šåˆ†åˆ—å…©é‚Š */
      align-items: center;
      margin-bottom: 12px; 
      flex-wrap: wrap; 
      gap: 16px; 
    }
    
    /* [æ–°å¢] æ¨™é¡Œå³å´çš„ç‹€æ…‹å®¹å™¨æ¨£å¼ */
    .header-status-container {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
        flex-wrap: wrap;
        font-size: 0.82rem; 
        color: #4b5563;
    }


    h1 {
      margin-top: 0;
      margin-bottom: 0;
      min-width: 0; 
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }
    
    .subtitle {
      margin-top: 4px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #4b5563;
    }

    .file-row,
    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .file-row label,
    .search-row label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    /* æ–°å¢ Summary å€å¡Šå…§çš„ Select æ¨£å¼ */
    .summary-select,
    #indexSearchInput {
      flex: 1;
      min-width: 150px; 
      padding: 6px 10px; 
      border-radius: 6px; 
      border: 1px solid #d1d5db;
      font-size: 0.9rem; 
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background-color: #ffffff;
      appearance: none; 
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3 3 3-3' stroke='%234B5563' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.6rem center;
      background-size: 1rem 1rem; 
      padding-right: 2rem; 
    }

    #indexSearchInput {
        min-width: 180px;
        padding: 9px 12px;
        font-size: 0.95rem;
        border-radius: 8px;
        background-position: right 0.75rem center;
        background-size: 1.25rem 1.25rem;
        padding-right: 2.5rem;
    }

    .summary-select:focus,
    #indexSearchInput:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }
    
    .hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .hint code {
      background: #eef2ff;
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 0.78rem;
    }

    /* ç‹€æ…‹åˆ—çš„æ¨£å¼èª¿æ•´ (ç¾åœ¨åªç”¨æ–¼ resultInfo) */
    .status-row {
      display: flex;
      justify-content: flex-start; 
      align-items: center;
      margin-top: 6px;
      margin-bottom: 8px;
      font-size: 0.82rem;
      color: #4b5563;
      gap: 12px; 
      flex-wrap: wrap;
    }
    
    /* è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºç‡ˆçš„æ¨£å¼ */
    .load-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        color: #f97316; 
        transition: color 0.3s;
    }
    .indicator-dot {
        width: 10px; 
        height: 10px;
        border-radius: 50%;
        background: #f97316; 
        transition: background-color 0.3s;
    }
    .load-indicator.ok {
        color: #047857;
    }
    .load-indicator.ok .indicator-dot {
        background: #047857; 
    }
    .load-indicator.error {
        color: #b91c1c; 
    }
    .load-indicator.error .indicator-dot {
        background: #b91c1c; 
    }
    
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-size: 0.78rem;
      gap: 6px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f46e5;
    }

    .pcs-summary {
      margin-top: 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      background: #f9fafb;
      font-size: 0.86rem;
    }

    .pcs-summary-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 1rem;
    }
    
    /* è®“ Section/Body System/Operation çš„ 3 ç¢¼å‰ç¶´æ›´æ˜é¡¯ */
    .highlight-code-prefix {
        font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-weight: 900 !important; 
        font-size: 1.2rem; 
        color: #1e40af; 
        margin-right: 6px;
    }


    /* Summary Detail å€å¡Šä½¿ç”¨ Grid ä½ˆå±€ï¼ŒåŒ…å« Select å…ƒç´  */
    .pcs-summary-detail {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr; /* ä¸‰å€‹æ¬„ä½ */
        gap: 8px;
        margin-bottom: 8px;
    }
    
    /* èª¿æ•´ Summary å…§éƒ¨çš„ Select å®¹å™¨æ¨£å¼ */
    .summary-select-container {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0; 
    }
    .summary-select-container span {
        font-style: italic;
        font-size: 0.78rem;
        color: #6b7280;
    }

    .pcs-summary-row {
      display: flex;
      gap: 8px;
      line-height: 1.4;
    }

    .pcs-summary-row span:first-child {
      font-style: italic;
      min-width: 80px;
    }

    .pcs-summary-code {
      font-weight: 700;
      margin-right: 4px;
    }

    .selected-code-box {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #d1d5db;
      font-size: 0.86rem;
    }

    /* è®“å®Œæ•´ 7 ç¢¼ä»£ç¢¼æ›´æ˜é¡¯ (è—è‰²ä¸»é¡Œ) */
    .selected-code-box code {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-weight: 900 !important; 
      font-size: 1.3rem !important; 
      color: #1e40af; 
      padding: 2px 6px;
      background-color: #eff6ff; 
      border-radius: 4px;
    }
    
    /* éŒ¯èª¤ä»£ç¢¼çš„æ¨£å¼è¦†è“‹ (ç¢ºä¿éŒ¯èª¤æç¤ºæ–‡å­—ä»æ˜¯ç´…è‰²ï¼Œä½†ä»£ç¢¼ä¸»è‰²æ˜¯è—è‰²) */
    .selected-code-box code:not([style*="color:#1e40af"]) {
        color: #1e40af !important; 
    }


    .table-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      overflow: auto;
      border: 1px solid #e5e7eb;
      background: #fafafa;
      max-height: 70vh;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 760px;
      font-size: 0.85rem;
    }

    thead {
      background: #f3f4ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th:last-child,
    td:last-child {
      border-right: none;
    }

    th {
      font-weight: 600;
      font-size: 0.78rem;
      color: #4b5563;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .no-result {
      padding: 16px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    .loading {
      color: #c05621;
    }

    .ok {
      color: #047857;
    }

    .error {
      color: #b91c1c; 
    }

    .option-row {
      display: flex;
      align-items: flex-start;
      gap: 4px;
      font-size: 0.83rem;
      line-height: 1.3;
    }

    .option-row input[type="radio"] {
      margin-top: 2px;
    }

    /* è®“ Body Part/Approach/Device/Qualifier çš„å–®ç¢¼ä»£ç¢¼æ›´æ˜é¡¯ (è—è‰²ä¸»é¡Œ) */
    .option-row .option-code {
        font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-weight: 900; 
        font-size: 1.0rem; 
        color: #1e40af; 
        margin-right: 6px;
    }

    /* Index æŸ¥è©¢çµæœå€å¡Š */
    /* èª¿æ•´ï¼šç§»é™¤å‚ç›´é‚Šè·ï¼Œç”±å¤–éƒ¨å®¹å™¨ç®¡ç† */
    .index-result-box {
      margin-top: 0; 
      margin-bottom: 0; 
      max-height: 220px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 6px 8px;
      font-size: 0.82rem;
    }

    .index-result-empty {
      color: #9ca3af;
      padding: 4px 2px;
    }

    .index-result-item {
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .index-result-item:last-child {
      border-bottom: none;
    }

    .index-path {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .index-codes {
      margin-top: 2px;
    }

    .index-code-chip {
      display: inline-block;
      margin-right: 6px;
      margin-top: 3px;
      padding: 1px 7px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid #e0e7ff;
      cursor: pointer;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 0.78rem;
    }

    .index-code-chip:hover {
      background: #e0e7ff;
    }

    .index-tip {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    
    /* [æ–°å¢] Index å€å¡Šçš„ Flex ä½ˆå±€å®¹å™¨ */
    .index-section-flex-container {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-top: 4px; 
        margin-bottom: 10px; 
    }

    @media (max-width: 640px) {
      .app {
        margin: 12px;
        padding: 16px;
        border-radius: 12px;
        padding-right: 16px; 
      }
      h1 {
        font-size: 1.3rem;
      }
      /* å°è¢å¹•ä¸‹ï¼Œç‹€æ…‹å€å¡Šæ‡‰è©²åœ¨æ¨™é¡Œä¸‹æ–¹ç¨ç«‹ä¸€è¡Œ */
      .header-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
      }
      .header-status-container {
        /* åœ¨å°è¢å¹•ä¸Šè®“ç‹€æ…‹å€å¡Šä½”æ»¿å¯¬åº¦ */
        width: 100%;
      }
      
      /* [ä¿®æ­£] å°è¢å¹•ä¸‹æµ®å‹•æŒ‰éˆ•ä½ç½®èª¿æ•´ */
      .floating-back-link {
        right: 10px; 
        top: 10px; 
        padding: 6px 12px;
        font-size: 0.8rem;
        border-radius: 6px;
      }
      .floating-clear-btn {
        top: 50px; /* 10px + é€£çµé«˜åº¦ ~30px + é–“éš” 10px */
        right: 10px; 
        padding: 6px 12px;
        font-size: 0.8rem;
        border-radius: 6px;
      }
      
      /* å°è¢å¹•ä¸‹ Summary å€å¡Šçš„ä½ˆå±€èª¿æ•´ */
      .pcs-summary-detail {
        grid-template-columns: 1fr; /* è®Šæˆå–®æ¬„ */
        gap: 10px;
      }
      
      /* [æ–°å¢] å°è¢å¹•ä¸‹ Index æŸ¥è©¢å€å¡Šæ”¹æˆå‚ç›´æ’åˆ— */
      .index-section-flex-container {
          flex-direction: column;
          gap: 10px; 
      }
    }
  </style>
</head>
<body>
  
  <a href="index.html" class="floating-back-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
    </svg>
    è¿”å›æœç´¢çµæœ
  </a>

  <button id="clearSelectionsBtn" class="floating-clear-btn" disabled>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
    </svg>
    æ¸…é™¤å·²é¸(4-7ç¢¼)
  </button>

  <div class="app">
    <div class="header-row">
      <h1>ICD-10-PCS æŸ¥è©¢</h1>
      
      <div class="header-status-container">
        <div id="integratedLoadStatus" class="load-indicator">
            <div id="indicatorDot" class="indicator-dot"></div>
            <span id="loadStatusText">æ•¸æ“šè¼‰å…¥ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</span>
        </div>
        <div class="badge">
          <span class="badge-dot"></span>
          <span>ä¾†æºï¼šICD-10-PCS 2023 - <span id="defHintText">å®šç¾©æª”è¼‰å…¥ä¸­...</span></span>
        </div>
      </div>
      
    </div>
    <div class="file-row"></div>
    <div class="search-row">
      <label for="indexSearchInput">è™•ç½®åç¨±ï¼š</label>
      <input
        id="indexSearchInput"
        type="text"
        placeholder="è¼‰å…¥ Index æª”å¾Œï¼Œå¯è¼¸å…¥è‹±æ–‡è™•ç½®åç¨±ï¼ˆä¾‹ï¼šAppendectomyï¼‰"
        autocomplete="off"
        disabled
      />
    </div>
    
    <div class="status-row">
      <div id="resultInfo">è«‹å…ˆè¼‰å…¥ Tables æª”ï¼Œå†é¸æ“‡å‰ 3 ç¢¼ã€‚</div>
    </div>

    <div class="index-section-flex-container">
      
      <div id="indexResultBox" class="index-result-box" style="flex-grow: 1;">
        <div class="index-result-empty">
          ç›®å‰å°šæœªè¼‰å…¥ Index XMLï¼Œæˆ–å°šæœªè¼¸å…¥è™•ç½®åç¨±ã€‚
        </div>
      </div>

      <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #d1d5db; display: flex; flex-direction: column; align-items: stretch; min-width: 200px; flex-shrink: 0;">
        <input
          type="text"
          id="prefixInput"
          maxlength="3"
          placeholder="ä½¿ç”¨å‰ä¸‰ç¢¼æŸ¥è©¢"
          style="
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 6px 10px;
            margin-bottom: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-transform: uppercase;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
          "
        />
        <button id="searchPrefixBtn" disabled style="
            background-color: hsl(0, 0%, 100%);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            line-height: normal;
          ">
          ğŸ”
        </button>
        <small id="prefixError" style="display: none; color: #dc2626; font-size: 0.75rem; margin-top: 6px;">
            è«‹è¼¸å…¥ä¸‰å€‹è‹±æ•¸å­—å…ƒ
        </small>
      </div>
    </div>
    <div id="pcsSummary" class="pcs-summary">
      <div id="summaryTitle" class="pcs-summary-title">
        é¸æ“‡å‰ 3 ç¢¼ä»¥æŸ¥è©¢ PCS Table
      </div>
      <div id="summaryDetail" class="pcs-summary-detail">
        <div class="summary-select-container">
            <span>Section (ç¬¬ 1 ç¢¼)</span>
            <select id="sectionSelect" class="summary-select" disabled>
                <option value="">-- è«‹å…ˆè¼‰å…¥ Tables æª” --</option>
            </select>
        </div>
        <div class="summary-select-container">
            <span>Body System (ç¬¬ 2 ç¢¼)</span>
            <select id="bodySystemSelect" class="summary-select" disabled>
                <option value="">-- è«‹å…ˆé¸æ“‡ Section --</option>
            </select>
        </div>
        <div class="summary-select-container">
            <span>Operation (ç¬¬ 3 ç¢¼)</span>
            <select id="operationSelect" class="summary-select" disabled>
                <option value="">-- è«‹å…ˆé¸æ“‡ Body System --</option>
            </select>
        </div>
      </div>
      <div id="selectedCodeBox" class="selected-code-box">
        ç›®å‰å°šæœªé¸å–å®Œæ•´ 7 ç¢¼ä»£ç¢¼ã€‚
      </div>
    </div>
    
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Body Part<br /><span style="font-weight:400;">ï¼ˆç¬¬ 4 ç¢¼ï¼‰</span></th>
            <th>Approach<br /><span style="font-weight:400;">ï¼ˆç¬¬ 5 ç¢¼ï¼‰</span></th>
            <th>Device<br /><span style="font-weight:400;">ï¼ˆç¬¬ 6 ç¢¼ï¼‰</span></th>
            <th>Qualifier<br /><span style="font-weight:400;">ï¼ˆç¬¬ 7 ç¢¼ï¼‰</span></th>
          </tr>
        </thead>
        <tbody id="resultBody">
          <tr>
            <td class="no-result" colspan="4">
              å°šæœªè¼‰å…¥è³‡æ–™ã€‚è«‹å…ˆé¸æ“‡ <code>icd10pcs_tables_2023.xml</code>ã€‚
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    
// å›ºå®šæª”æ¡ˆçš„è·¯å¾‘
const TABLES_XML_URL = "icd10pcs_tables_2023.xml";
const DEFINITIONS_XML_URL = "icd10pcs_definitions_2023.xml";
const INDEX_XML_URL = "icd10pcs_index_2023.xml";

// XML è¼‰å…¥ç‹€æ…‹
const LOAD_STATUS = {
  NOT_LOADED: "å°šæœªè¼‰å…¥",
  LOADING: "è¼‰å…¥ä¸­...",
  OK: "è¼‰å…¥å®Œæˆ",
  ERROR: "è¼‰å…¥å¤±æ•—",
};

// å…ƒç´ åƒè€ƒ
const integratedLoadStatus = document.getElementById("integratedLoadStatus");
const indicatorDot = document.getElementById("indicatorDot");
const loadStatusText = document.getElementById("loadStatusText");
const defHintText = document.getElementById("defHintText"); 

const sectionSelect = document.getElementById("sectionSelect");
const bodySystemSelect = document.getElementById("bodySystemSelect");
const operationSelect = document.getElementById("operationSelect");

const indexSearchInput = document.getElementById("indexSearchInput");
const resultBody = document.getElementById("resultBody");
const resultInfo = document.getElementById("resultInfo");
const summaryTitle = document.getElementById("summaryTitle");
const summaryDetail = document.getElementById("summaryDetail"); 
const selectedCodeBox = document.getElementById("selectedCodeBox");
const indexResultBox = document.getElementById("indexResultBox");

// æ–°å¢ï¼šæ¸…é™¤é¸æ“‡æŒ‰éˆ•çš„å¼•ç”¨
const clearSelectionsBtn = document.getElementById("clearSelectionsBtn");

// [æ–°å¢] ç›´æ¥è¼¸å…¥å‰ä¸‰ç¢¼çš„å…ƒç´ åƒè€ƒ
const prefixInput = document.getElementById('prefixInput');
const searchPrefixBtn = document.getElementById('searchPrefixBtn');
const prefixError = document.getElementById('prefixError');


// æ•¸æ“šå­˜å„²
let icdCodes = []; // [{code, desc}]
let icdCodeMap = new Map(); // code -> desc
let isLoaded = false;
let validMap = new Map(); // å­˜å„²æ‰€æœ‰ 3 ç¢¼å‰ç¶´çš„åˆæ³•é¸é …å’Œçµ„åˆ
let sectionOptions = new Map(); // code -> text
let bodySystemOptions = new Map(); // code -> Map(text -> prefixes)
let operationOptions = new Map(); // code -> Map(text -> prefixes)

const definitionMaps = {
  bodypart: new Map(),
  device: new Map(),
};
let defLoaded = false;
let indexEntries = [];
let indexLoaded = false;
let currentPrefix = "";
let selections = {
  bodypart: null,
  approach: null,
  device: null,
  qualifier: null,
};

// è¿½è¹¤ä¸‰å€‹ XML æª”æ¡ˆçš„è¼‰å…¥ç‹€æ…‹
const fileLoadState = {
    tables: LOAD_STATUS.NOT_LOADED,
    definitions: LOAD_STATUS.NOT_LOADED,
    index: LOAD_STATUS.NOT_LOADED,
};


// --- è¼”åŠ©å‡½æ•¸ ---

// æ•´åˆä¸‰å€‹ç‹€æ…‹æ›´æ–°å‡½æ•¸ç‚ºä¸€å€‹ï¼Œè² è²¬æ›´æ–°ç‹€æ…‹è¿½è¹¤ç‰©ä»¶å’Œ UI
function updateIntegratedStatus(file, status) {
    fileLoadState[file] = status;

    let overallStatus = LOAD_STATUS.LOADING;
    let statusMsg = "";

    // æª¢æŸ¥æ•´é«”ç‹€æ…‹å’Œç”Ÿæˆè¨Šæ¯
    const tablesOK = fileLoadState.tables === LOAD_STATUS.OK;
    const defsOK = fileLoadState.definitions === LOAD_STATUS.OK;
    const indexOK = fileLoadState.index === LOAD_STATUS.OK;
    
    if (fileLoadState.tables === LOAD_STATUS.ERROR || 
        fileLoadState.definitions === LOAD_STATUS.ERROR || 
        fileLoadState.index === LOAD_STATUS.ERROR) {
        overallStatus = LOAD_STATUS.ERROR;
        statusMsg = "æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆã€‚";
    } else if (tablesOK && defsOK && indexOK) {
        overallStatus = LOAD_STATUS.OK;
        // é¡¯ç¤º Tables çš„ç¸½æ•¸ï¼ˆTables XML è¼‰å…¥æ™‚å¯ä»¥è¨ˆç®—ï¼‰
        statusMsg = `æ‰€æœ‰æ•¸æ“šè¼‰å…¥å®Œæˆï¼ˆTables: ${validMap.size} çµ„å‰ç¶´, Index: ${indexEntries.length} æ¢ï¼‰`;
    } else if (fileLoadState.tables === LOAD_STATUS.LOADING || 
               fileLoadState.definitions === LOAD_STATUS.LOADING || 
               fileLoadState.index === LOAD_STATUS.LOADING) {
        overallStatus = LOAD_STATUS.LOADING;
        let loadingFiles = [];
        if (fileLoadState.tables === LOAD_STATUS.LOADING) loadingFiles.push("Tables");
        if (fileLoadState.definitions === LOAD_STATUS.LOADING) loadingFiles.push("Definitions");
        if (fileLoadState.index === LOAD_STATUS.LOADING) loadingFiles.push("Index");
        statusMsg = `æ•¸æ“šè¼‰å…¥ä¸­... (${loadingFiles.join(", ")})`;
    } else {
        overallStatus = LOAD_STATUS.NOT_LOADED;
        statusMsg = "å°šæœªè¼‰å…¥æ•¸æ“šã€‚";
    }

    // æ›´æ–° UI
    loadStatusText.textContent = statusMsg;
    integratedLoadStatus.className = 'load-indicator ' + (overallStatus === LOAD_STATUS.OK ? 'ok' : overallStatus === LOAD_STATUS.ERROR ? 'error' : 'loading');

    // ç‰¹æ®Šè™•ç† Definitions çš„æç¤ºæ–‡å­— (æ›´æ–°å³å´ badge å…§çš„æ–‡å­—)
    if (defsOK) {
        defHintText.textContent = 'æ»‘é¼ æ‡¸åœé¡¯ç¤º Body Part/Device å®šç¾©';
        defLoaded = true; // ç¢ºä¿ defLoaded ç‹€æ…‹æ­£ç¢ºæ›´æ–°
    } else if (fileLoadState.definitions === LOAD_STATUS.ERROR) {
        defHintText.textContent = 'å®šç¾©æª”è¼‰å…¥å¤±æ•—';
        defLoaded = false;
    } else {
        defHintText.textContent = 'å®šç¾©æª”è¼‰å…¥ä¸­...';
        defLoaded = false;
    }
    
    // ç¢ºä¿ Index è¼‰å…¥ç‹€æ…‹ä¹Ÿæ­£ç¢ºæ›´æ–°
    if (indexOK) {
        indexLoaded = true;
        // Index è¼‰å…¥å®Œæˆå¾Œå•Ÿç”¨æœç´¢æ¡†
        indexSearchInput.disabled = false; 
        indexSearchInput.placeholder = "è¼¸å…¥è‹±æ–‡è™•ç½®åç¨±ï¼ˆä¾‹ï¼šAppendectomyï¼‰";
    } else {
        indexLoaded = false;
        indexSearchInput.disabled = true;
        indexSearchInput.placeholder = "è¼‰å…¥ Index æª”å¾Œï¼Œå¯è¼¸å…¥è‹±æ–‡è™•ç½®åç¨±ï¼ˆä¾‹ï¼šAppendectomyï¼‰";
    }
}


function setResultInfo(text) {
  resultInfo.textContent = text;
}
function resetTablePlaceholder(text) {
  resultBody.innerHTML = `<tr><td class="no-result" colspan="4">${text}</td></tr>`;
}
function resetSelections() {
  selections = {
    bodypart: null,
    approach: null,
    device: null,
    qualifier: null,
  };
  // å–æ¶ˆæ‰€æœ‰ radio button çš„é¸å–ç‹€æ…‹
  document.querySelectorAll('input[type="radio"]').forEach(r => {
    r.checked = false;
    r.disabled = false; // é‡ç½®æ™‚ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½å•Ÿç”¨
    r.parentElement.style.opacity = 1; // é‡ç½®æ™‚ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½å¯è¦‹
  });

  updateSelectedCode(); // åœ¨é‡ç½®é¸é …æ™‚æ›´æ–°é¡¯ç¤º
}

function resetSummaryHeader() {
  summaryTitle.textContent = "é¸æ“‡å‰ 3 ç¢¼ä»¥æŸ¥è©¢ PCS Table";
  
  sectionSelect.value = "";
  bodySystemSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡ Section --</option>';
  operationSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡ Body System --</option>';
  bodySystemSelect.disabled = true;
  operationSelect.disabled = true;

  selectedCodeBox.textContent = "ç›®å‰å°šæœªé¸å–å®Œæ•´ 7 ç¢¼ä»£ç¢¼ã€‚";
}

function escapeHtmlAttr(str) {
  if (typeof str !== "string") return str;
  return str.replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}

function getDefinitionTooltip(kind, term) {
  return definitionMaps[kind] ? definitionMaps[kind].get(term) : null;
}

function isValidCombination(c4, c5, c6, c7) {
  if (!currentPrefix || !validMap.has(currentPrefix)) return false;
  const combos = validMap.get(currentPrefix).combos;
  const fullCode = currentPrefix + c4 + c5 + c6 + c7;
  return combos.has(fullCode);
}

function debounce(func, delay) {
  let timeoutId;
  return function (...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
}

// XML è§£æçš„è¼”åŠ©å‡½æ•¸ (ä¸è®Š)
function getDirectAxisLabels(parent, axisPos) {
  const axis = parent.querySelector(`axis[pos="${axisPos}"]`);
  return axis ? Array.from(axis.getElementsByTagName("label")) : [];
}

// -------- Tables XML è§£æ --------
async function loadTables() {
  updateIntegratedStatus('tables', LOAD_STATUS.LOADING);
  // ç¦ç”¨æ‰€æœ‰ Select å…ƒç´ 
  sectionSelect.disabled = true;
  bodySystemSelect.disabled = true;
  operationSelect.disabled = true;
  // ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
  clearSelectionsBtn.disabled = true;


  try {
    const response = await fetch(TABLES_XML_URL);
    if (!response.ok) throw new Error("æ–‡ä»¶æ‰¾ä¸åˆ°æˆ–ä¼ºæœå™¨éŒ¯èª¤");
    const xmlText = await response.text();
    parseIcd10PcsXml(xmlText);
    updateIntegratedStatus('tables', LOAD_STATUS.OK);
    // è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– Select é¸å–®
    initSectionSelect();
    isLoaded = true;
  } catch (err) {
    updateIntegratedStatus('tables', LOAD_STATUS.ERROR);
    isLoaded = false;
  }
}

function parseIcd10PcsXml(xmlText) {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "application/xml");
  const parserError = xmlDoc.querySelector("parsererror");
  if (parserError) {
    throw new Error("Tables XML æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚");
  }
  const tables = Array.from(xmlDoc.getElementsByTagName("pcsTable"));
  if (!tables.length) {
    throw new Error(
      "Tables XML ä¸­æ‰¾ä¸åˆ° pcsTable ç¯€é»ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¢ºçš„æª”æ¡ˆã€‚"
    );
  }
  icdCodes = [];
  icdCodeMap.clear();
  validMap.clear();

  // æ¸…é™¤ä¸¦åˆå§‹åŒ– Section/Body System/Operation é¸é …
  sectionOptions.clear();
  bodySystemOptions.clear();
  operationOptions.clear();

  tables.forEach((table) => {
    // 1. å–å¾—å‰ä¸‰ç¢¼çš„è³‡è¨Š
    const s = table.querySelector('axis[pos="1"] label');
    const bs = table.querySelector('axis[pos="2"] label');
    const op = table.querySelector('axis[pos="3"] label');

    if (!s || !bs || !op) return; // ç•¥éä¸å®Œæ•´çš„ Table

    const sCode = (s.getAttribute("code") || "").toUpperCase();
    const sText = s.textContent.trim();
    if (sCode) sectionOptions.set(sCode, sText);

    const bsCode = (bs.getAttribute("code") || "").toUpperCase();
    const bsText = bs.textContent.trim();
    // å„²å­˜ Body System é¸é …ï¼Œä¸¦ç´€éŒ„å®ƒå±¬æ–¼å“ªå€‹ Section
    if (bsCode) {
      if (!bodySystemOptions.has(sCode)) bodySystemOptions.set(sCode, new Map());
      bodySystemOptions.get(sCode).set(bsCode, bsText);
    }

    const opCode = (op.getAttribute("code") || "").toUpperCase();
    const opText = op.textContent.trim();
    // å„²å­˜ Operation é¸é …ï¼Œä¸¦ç´€éŒ„å®ƒå±¬æ–¼å“ªå€‹ Body System
    if (opCode) {
      const prefix2 = sCode + bsCode;
      if (!operationOptions.has(prefix2))
        operationOptions.set(prefix2, new Map());
      operationOptions.get(prefix2).set(opCode, opText);
    }

    const prefix = sCode + bsCode + opCode;
    if (prefix.length !== 3) return;

    // 2. å–å¾— 4-7 ç¢¼çš„é¸é …å’Œæ‰€æœ‰çµ„åˆ
    const pcsRows = Array.from(table.getElementsByTagName("pcsRow"));

    // åˆå§‹åŒ– validMap
    if (!validMap.has(prefix)) {
      validMap.set(prefix, {
        body: new Map(),
        approach: new Map(),
        device: new Map(),
        qualifier: new Map(),
        combos: new Set(),
        header: [sText, bsText, opText],
      });
    }

    const vm = validMap.get(prefix);

    pcsRows.forEach((row) => {
      const bpLabels = getDirectAxisLabels(row, 4);
      const apLabels = getDirectAxisLabels(row, 5);
      const dvLabels = getDirectAxisLabels(row, 6);
      const qLabels = getDirectAxisLabels(row, 7);

      bpLabels.forEach((bp) => {
        const bpCode = (bp.getAttribute("code") || "").toUpperCase();
        const bpText = bp.textContent.trim();
        if (bpCode) vm.body.set(bpCode, bpText);

        apLabels.forEach((ap) => {
          const apCode = (ap.getAttribute("code") || "").toUpperCase();
          const apText = ap.textContent.trim();
          if (apCode) vm.approach.set(apCode, apText);

          dvLabels.forEach((dv) => {
            const dvCode = (dv.getAttribute("code") || "").toUpperCase();
            const dvText = dv.textContent.trim();
            if (dvCode) vm.device.set(dvCode, dvText);

            qLabels.forEach((q) => {
              const qCode = (q.getAttribute("code") || "").toUpperCase();
              const qText = q.textContent.trim();
              if (qCode) vm.qualifier.set(qCode, qText);

              // å„²å­˜å®Œæ•´çš„ 7 ç¢¼ä»£ç¢¼çµ„åˆ
              const fullCode = prefix + bpCode + apCode + dvCode + qCode;
              vm.combos.add(fullCode);

              // å„²å­˜å®Œæ•´çš„ä»£ç¢¼æè¿°
              const desc = `${sText} / ${bsText} / ${opText} / ${bpText} / ${apText} / ${dvText} / ${qText}`;
              icdCodes.push({ code: fullCode, desc: desc });
              icdCodeMap.set(fullCode, desc);
            });
          });
        });
      });
    });
  });
}

// -------- è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– Section Select --------
function initSectionSelect() {
  sectionSelect.innerHTML = '<option value="">-- Section --</option>'; // èª¿æ•´æç¤ºæ–‡å­—
  // å°‡ Map è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
  const sortedSections = Array.from(sectionOptions.entries()).sort((a, b) => a[0].localeCompare(b[0]));
  sortedSections.forEach(([code, text]) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = `${code} - ${text}`;
    sectionSelect.appendChild(option);
  });
  sectionSelect.disabled = false;
}

// -------- Section é¸æ“‡ Body System --------
function updateBodySystemSelect(sectionCode) {
  bodySystemSelect.innerHTML = '<option value="">-- Body System --</option>';
  if (sectionCode && bodySystemOptions.has(sectionCode)) {
    const optionsMap = bodySystemOptions.get(sectionCode);
    // å°‡ Map è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
    const sortedOptions = Array.from(optionsMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    sortedOptions.forEach(([code, text]) => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = `${code} - ${text}`;
      bodySystemSelect.appendChild(option);
    });
    bodySystemSelect.disabled = false;
  } else {
    bodySystemSelect.disabled = true;
  }
  operationSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡ Body System --</option>';
  operationSelect.disabled = true;
  // æ¯æ¬¡æ›´æ–°éƒ½è§¸ç™¼ä¸€æ¬¡æŸ¥è©¢ï¼Œä»¥æ¸…é™¤çµæœæˆ–é¡¯ç¤ºæ–°çµæœ
  doSearch();
}

// -------- Body System é¸æ“‡ Operation --------
function updateOperationSelect(sectionCode, bodySystemCode) {
  operationSelect.innerHTML = '<option value="">-- Operation --</option>';
  const prefix2 = sectionCode + bodySystemCode;
  if (prefix2.length === 2 && operationOptions.has(prefix2)) {
    const optionsMap = operationOptions.get(prefix2);
    // å°‡ Map è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
    const sortedOptions = Array.from(optionsMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    sortedOptions.forEach(([code, text]) => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = `${code} - ${text}`;
      operationSelect.appendChild(option);
    });
    operationSelect.disabled = false;
  } else {
    operationSelect.disabled = true;
  }
  // æ¯æ¬¡æ›´æ–°éƒ½è§¸ç™¼ä¸€æ¬¡æŸ¥è©¢ï¼Œä»¥æ¸…é™¤çµæœæˆ–é¡¯ç¤ºæ–°çµæœ
  doSearch();
}

// -------- Definitions XML è§£æ (ä¸è®Š) --------
async function loadDefinitions() {
  updateIntegratedStatus('definitions', LOAD_STATUS.LOADING);
  try {
    const response = await fetch(DEFINITIONS_XML_URL);
    if (!response.ok) throw new Error("æ–‡ä»¶æ‰¾ä¸åˆ°æˆ–ä¼ºæœå™¨éŒ¯èª¤");
    const xmlText = await response.text();
    parseIcd10PcsDefinitions(xmlText);
    updateIntegratedStatus('definitions', LOAD_STATUS.OK);
  } catch (err) {
    updateIntegratedStatus('definitions', LOAD_STATUS.ERROR);
  }
}

function parseIcd10PcsDefinitions(xmlText) {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "application/xml");
  const parserError = xmlDoc.querySelector("parsererror");
  if (parserError) {
    throw new Error("Definitions XML æ ¼å¼è§£æå¤±æ•—ã€‚");
  }
  ["bodypart", "device"].forEach((kind) => {
    const definitions = Array.from(xmlDoc.getElementsByTagName(kind));
    definitions.forEach((def) => {
      const termsNodes = Array.from(def.getElementsByTagName("terms"));
      termsNodes.forEach((terms) => {
        const titleNodes = Array.from(
          terms.getElementsByTagName("title")
        );
        const defNode = terms.getElementsByTagName("definition")[0];
        const explNode = terms.getElementsByTagName("explanation")[0];
        const includeNodes = Array.from(
          terms.getElementsByTagName("includes")
        );

        const lines = [];
        if (defNode) {
          lines.push(`å®šç¾©: ${defNode.textContent.trim()}`);
        }
        if (explNode) {
          lines.push(`è§£é‡‹: ${explNode.textContent.trim()}`);
        }
        if (includeNodes.length) {
          lines.push(
            `åŒ…å«: ${includeNodes
              .map((n) => n.textContent.trim())
              .join(", ")}`
          );
        }

        if (lines.length) {
          titleNodes.forEach((titleNode) => {
            const title = titleNode.textContent.trim();
            if (title) {
              definitionMaps[kind].set(
                title.toUpperCase(),
                lines.join("\n")
              );
            }
          });
        }
      });
    });
  });
}

// -------- Index XML è§£æ (ä¸è®Š) --------
async function loadIndex() {
  updateIntegratedStatus('index', LOAD_STATUS.LOADING);
  try {
    const response = await fetch(INDEX_XML_URL);
    if (!response.ok) throw new Error("æ–‡ä»¶æ‰¾ä¸åˆ°æˆ–ä¼ºæœå™¨éŒ¯èª¤");
    const xmlText = await response.text();
    indexEntries = parseIcd10PcsIndex(xmlText);
    updateIntegratedStatus('index', LOAD_STATUS.OK);
  } catch (err) {
    updateIntegratedStatus('index', LOAD_STATUS.ERROR);
  }
}

function getDirectTitle(node) {
  const titleNode = node.querySelector("title");
  return titleNode ? titleNode.textContent.trim() : "";
}

function traverseIndexNode(node, currentPath, entries) {
  const title = getDirectTitle(node);
  const nextPath = [...currentPath, title];
  
  const codeNode = node.querySelector("code");
  const code = codeNode ? codeNode.textContent.trim() : null;

  if (code) {
    entries.push({
      path: nextPath.join(" â€” "),
      codes: [code],
    });
  }

  // è™•ç†æ‰€æœ‰çš„ subTermï¼ŒåŒ…å«åœ¨ current node å…§çš„
  const subTerms = Array.from(node.children).filter(child => child.tagName === 'subTerm');
  
  subTerms.forEach((st) => {
    traverseIndexNode(st, nextPath, entries);
  });
}


function parseIcd10PcsIndex(xmlText) {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "application/xml");
  const parserError = xmlDoc.querySelector("parsererror");
  if (parserError) {
    throw new Error("Index XML æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚");
  }

  const entries = [];
  const letters = Array.from(xmlDoc.getElementsByTagName("letter"));

  letters.forEach((letter) => {
    const mainTerms = Array.from(letter.getElementsByTagName("mainTerm"));
    mainTerms.forEach((mt) => {
      traverseIndexNode(mt, [], entries);
    });
  });

  return entries;
}

// -------- è¼”åŠ©å‡½æ•¸ï¼šç²å–å–®ä¸€å­—å…ƒæè¿° --------
function getCharDescription(charIndex, charCode, currentCodePrefix) {
  if (!charCode) return null;
  const char = charCode.toUpperCase();

  switch (charIndex) {
    case 1: // Section (ç¬¬ 1 ç¢¼)
      return sectionOptions.get(char);
    case 2: // Body System (ç¬¬ 2 ç¢¼)
      return bodySystemOptions.get(currentCodePrefix).get(char);
    case 3: // Operation (ç¬¬ 3 ç¢¼)
      return operationOptions.get(currentCodePrefix).get(char);
    case 4: // Body Part (ç¬¬ 4 ç¢¼)
      if (currentPrefix.length === 3 && validMap.has(currentPrefix)) {
        return validMap.get(currentPrefix).body.get(char);
      }
      return null;
    case 5: // Approach (ç¬¬ 5 ç¢¼)
      if (currentPrefix.length === 3 && validMap.has(currentPrefix)) {
        return validMap.get(currentPrefix).approach.get(char);
      }
      return null;
    case 6: // Device (ç¬¬ 6 ç¢¼)
      if (currentPrefix.length === 3 && validMap.has(currentPrefix)) {
        return validMap.get(currentPrefix).device.get(char);
      }
      return null;
    case 7: // Qualifier (ç¬¬ 7 ç¢¼)
      if (currentPrefix.length === 3 && validMap.has(currentPrefix)) {
        return validMap.get(currentPrefix).qualifier.get(char);
      }
      return null;
    default:
      return null;
  }
}

// -------- æ›´æ–°å·²é¸ä»£ç¢¼çš„é¡¯ç¤º (ç¬¬ 1-7 ç¢¼) --------
function updateSelectedCode() {
  const codes = [
    sectionSelect.value,
    bodySystemSelect.value,
    operationSelect.value,
    selections.bodypart,
    selections.approach,
    selections.device,
    selections.qualifier
  ].map(c => c ? c.toUpperCase() : ''); // ç¢ºä¿ç‚ºå¤§å¯«æˆ–ç©ºå­—ä¸²

  let partialCode = '';
  let descriptionParts = [];
  let isComplete = true;

  // 1. æ§‹å»ºéƒ¨åˆ†ä»£ç¢¼å’Œæè¿°
  for (let i = 0; i < 7; i++) {
    const charCode = codes[i];
    const charIndex = i + 1; // 1-based index (1-7)
    const currentCodePrefix = partialCode;
    
    if (charCode && charCode.length === 1) {
      // æª¢æŸ¥å‰ä¸‰ç¢¼æ˜¯å¦å·²é¸é½Šï¼Œå¦‚æœæœªé¸é½Šï¼Œå‰‡ä¸èƒ½ç¹¼çºŒæŸ¥æ‰¾å¾ŒçºŒå­—å…ƒæè¿°
      if (charIndex > 3 && currentPrefix.length !== 3) {
          isComplete = false;
          partialCode += '_'.repeat(7 - partialCode.length);
          break;
      }
      partialCode += charCode;
      
      // å˜—è©¦ç²å–æè¿°
      const desc = getCharDescription(charIndex, charCode, currentCodePrefix);
      
      // åªæœ‰ç•¶æè¿°ç¢ºå¯¦å­˜åœ¨æ™‚æ‰åŠ å…¥
      if (desc) {
        // åªæ”¶é›†ç¬¬ 3 ç¢¼åˆ°ç¬¬ 7 ç¢¼çš„æè¿°
        if (charIndex >= 3) {
            descriptionParts.push(desc);
        }
      } else {
        isComplete = false;
        partialCode += '_'.repeat(7 - partialCode.length);
        break;
      }
    } else {
      // é‡åˆ°ç¬¬ä¸€å€‹æœªé¸å–çš„å­—å…ƒ
      partialCode += '_'.repeat(7 - partialCode.length);
      isComplete = false;
      break;
    }
  }

  // 2. æº–å‚™é¡¯ç¤ºå…§å®¹
  let displayCode = `<code style="font-size: 1.3rem !important;">${partialCode}</code>`;
  let displayDescription = descriptionParts.join(', ');
  
  const selectedCount = partialCode.replace(/_/g, '').length;

  if (selectedCount === 0) {
    selectedCodeBox.textContent = "ç›®å‰å°šæœªé¸å–å®Œæ•´ 7 ç¢¼ä»£ç¢¼ã€‚";
    // å¦‚æœæ²’æœ‰é¸å–ä»»ä½•ä»£ç¢¼ï¼Œå‰‡ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
    if (isLoaded && currentPrefix.length === 3) {
      // åªæœ‰åœ¨è¼‰å…¥ä¸”æœ‰å‰ç¶´æ™‚ï¼Œæ‰è®“å®ƒä¿æŒå•Ÿç”¨ï¼Œå› ç‚º doSearch æœƒè™•ç†
    } else {
        clearSelectionsBtn.disabled = true;
    }
  } else if (isComplete && currentPrefix.length === 3) {
    // æª¢æŸ¥çµ„åˆæ˜¯å¦åˆæ³•
    const fullCode = partialCode;
    const isValid = isValidCombination(codes[3], codes[4], codes[5], codes[6]);

    if (isValid) {
      selectedCodeBox.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">å·²å®Œæˆä»£ç¢¼ï¼š${displayCode}</div>
        <div style="font-size: 0.8rem; color: #4b5563;">${displayDescription}</div>
      `;
      clearSelectionsBtn.disabled = false;
    } else {
      selectedCodeBox.innerHTML = `
        <div style="font-weight: 600; color: #dc2626; margin-bottom: 4px;">éŒ¯èª¤ä»£ç¢¼ï¼š${displayCode}</div>
        <div style="font-size: 0.8rem; color: #dc2626;">æ­¤ 7 ç¢¼çµ„åˆä¸åˆæ³•ã€‚è«‹èª¿æ•´ 4-7 ç¢¼é¸é …ã€‚</div>
      `;
      clearSelectionsBtn.disabled = false;
    }
  } else {
    // éƒ¨åˆ†ä»£ç¢¼
    selectedCodeBox.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 4px;">éƒ¨åˆ†ä»£ç¢¼ï¼š${displayCode}</div>
      <div style="font-size: 0.8rem; color: #9ca3af;">å°šæœªå®Œæˆ 7 ç¢¼é¸æ“‡ã€‚${descriptionParts.length > 0 ? `ç›®å‰ï¼š${displayDescription}` : ''}</div>
    `;
    // åªè¦æœ‰é¸å– 4-7 ç¢¼çš„ä»»ä½•ä¸€ç¢¼ï¼Œå°±å•Ÿç”¨æ¸…é™¤æŒ‰éˆ•
    if (selections.bodypart || selections.approach || selections.device || selections.qualifier) {
        clearSelectionsBtn.disabled = false;
    } else {
        clearSelectionsBtn.disabled = true;
    }
  }
}

// -------- æ¸²æŸ“è¡¨æ ¼ (ç¬¬ 4-7 ç¢¼) --------
function renderAxisTable(matched, prefix, totalMatched) {
  if (!totalMatched) {
    if (!prefix) {
      resetTablePlaceholder("è«‹åœ¨ä¸Šæ–¹é¸æ“‡ PCS å‰ 3 ç¢¼ã€‚");
      setResultInfo("è«‹é¸æ“‡æŸ¥è©¢æ¢ä»¶ã€‚");
      resetSummaryHeader();
      resetSelections();
      clearSelectionsBtn.disabled = true; // <-- æ–°å¢: æ²’æœ‰å‰ç¶´æ™‚ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
      return;
    }
    if (!matched.length) {
      resetTablePlaceholder("æ­¤å‰ 3 ç¢¼æ²’æœ‰å°æ‡‰çš„çµ„åˆã€‚");
      setResultInfo(`ã€Œ${prefix}ã€æŸ¥ç„¡çµæœã€‚`);
      // æŸ¥ç„¡çµæœæ™‚ï¼Œåªæ›´æ–° Title å’Œ Selected Codeï¼ŒSelect ä¿æŒåŸé¸å€¼
      summaryTitle.innerHTML = `<span class="highlight-code-prefix">${prefix}</span> - æŸ¥ç„¡çµæœ`;
      selectedCodeBox.textContent = "ç›®å‰ä»£ç¢¼æŸ¥ç„¡çµæœã€‚";
      resetSelections();
      clearSelectionsBtn.disabled = true; // <-- æ–°å¢: æŸ¥ç„¡çµæœæ™‚ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
      return;
    }
  }
  
  // 1. æå–æ‰€æœ‰å¯èƒ½çš„ 4-7 ç¢¼é¸é …
  const bodyParts = new Map();
  const approaches = new Map();
  const devices = new Map();
  const qualifiers = new Map();
  let headerInfo = null;

  matched.forEach((item) => {
    const code = item.code || "";
    const parts = (item.desc || "").split(" / ");
    
    if (!headerInfo && parts.length >= 3) {
      headerInfo = {
        secCode: code[0],
        secText: parts[0] || "",
        bsCode: code[1],
        bsText: parts[1] || "",
        opCode: code[2],
        opText: parts[2] || "",
      };
    }
    
    const c4 = code[3];
    const c5 = code[4];
    const c6 = code[5];
    const c7 = code[6];
    
    const bpText = parts[3] || "";
    const apText = parts[4] || "";
    const dvText = parts[5] || "";
    const qText = parts[6] || "";

    if (c4) bodyParts.set(c4, bpText);
    if (c5) approaches.set(c5, apText);
    if (c6) devices.set(c6, dvText);
    if (c7) qualifiers.set(c7, qText);
  });
  
  // 2. æ’åºé¸é …ä¸¦ç”Ÿæˆ HTML
  const getSortedArray = (map) => Array.from(map.entries()).sort((a, b) => a[0].localeCompare(b[0]));

  const bpArr = getSortedArray(bodyParts);
  const apArr = getSortedArray(approaches);
  const dvArr = getSortedArray(devices);
  const qArr = getSortedArray(qualifiers);

  const maxRows = Math.max(
    bpArr.length,
    apArr.length,
    dvArr.length,
    qArr.length
  );
  
  let bodyHtml = "";
  
  for (let i = 0; i < maxRows; i++) {
    const [bpCode, bpText] = bpArr[i] || ["", ""];
    const [apCode, apText] = apArr[i] || ["", ""];
    const [dvCode, dvText] = dvArr[i] || ["", ""];
    const [qCode, qText] = qArr[i] || ["", ""];

    // ç²å–å®šç¾©ï¼Œç”¨æ–¼ tooltip
    const bpDef = defLoaded && bpCode ? getDefinitionTooltip("bodypart", bpText) : "";
    const dvDef = defLoaded && dvCode ? getDefinitionTooltip("device", dvText) : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td> ${bpCode ? `
        <label class="option-row">
          <input type="radio" name="bodypart" value="${bpCode}">
          <span class="option-code">${bpCode}</span> 
          <span ${bpDef ? `title="${escapeHtmlAttr(bpDef)}"` : ""}>${bpText}</span>
        </label>
        ` : ""} </td>
      <td> ${apCode ? `
        <label class="option-row">
          <input type="radio" name="approach" value="${apCode}">
          <span class="option-code">${apCode}</span> 
          <span>${apText}</span>
        </label>
        ` : ""} </td>
      <td> ${dvCode ? `
        <label class="option-row">
          <input type="radio" name="device" value="${dvCode}">
          <span class="option-code">${dvCode}</span> 
          <span ${dvDef ? `title="${escapeHtmlAttr(dvDef)}"` : ""}>${dvText}</span>
        </label>
        ` : ""} </td>
      <td> ${qCode ? `
        <label class="option-row">
          <input type="radio" name="qualifier" value="${qCode}">
          <span class="option-code">${qCode}</span> 
          <span>${qText}</span>
        </label>
        ` : ""} </td>
    `;
    bodyHtml += tr.outerHTML;
  }
  
  resultBody.innerHTML = bodyHtml;

  // ç§»é™¤ç”¨æˆ¶è¦æ±‚ç§»é™¤çš„ç‹€æ…‹è¨Šæ¯
  setResultInfo(
    `ç›®å‰é¡¯ç¤º ${totalMatched} æ¢å®Œæ•´ 7 ç¢¼ä»£ç¢¼ï¼Œå…± ${matched.length} ç¨®çµ„åˆã€‚`
  );

  // æ›´æ–° Summary æ¨™é ­
  if (headerInfo) {
    summaryTitle.innerHTML = `<span class="highlight-code-prefix">${headerInfo.secCode}${headerInfo.bsCode}${headerInfo.opCode}</span> - ${headerInfo.opText}`;
  }
  
  clearSelectionsBtn.disabled = false; // <-- æ–°å¢: æˆåŠŸæ¸²æŸ“è¡¨æ ¼å¾Œå•Ÿç”¨æ¸…é™¤æŒ‰éˆ•
}

// -------- æ‡‰ç”¨æœ€å¯èƒ½çµ„åˆä¸¦éæ¿¾ (ä¸è®Š) --------
function applyMostLikelyAndFilter() {
  if (!currentPrefix || !validMap.has(currentPrefix)) return;
  
  const vm = validMap.get(currentPrefix);
  const selectedBodypart = selections.bodypart;
  const selectedApproach = selections.approach;
  const selectedDevice = selections.device;
  const selectedQualifier = selections.qualifier;

  // 1. ç¢ºå®šæ‰€æœ‰å€™é¸åˆ—è¡¨ï¼ˆåªè€ƒæ…®ç•¶å‰å‰ç¶´ä¸‹çš„åˆæ³•é¸é …ï¼‰
  const bodypartCandidates = selectedBodypart ? [selectedBodypart] : Array.from(vm.body.keys());
  const approachCandidates = selectedApproach ? [selectedApproach] : Array.from(vm.approach.keys());
  const deviceCandidates = selectedDevice ? [selectedDevice] : Array.from(vm.device.keys());
  const qualCandidates = selectedQualifier ? [selectedQualifier] : Array.from(vm.qualifier.keys());

  // 2. éæ¿¾è¡¨æ ¼ä¸­ä¸åˆæ³•çš„çµ„åˆ (ç¦ç”¨ radio buttons)

  // Body Part (ç¬¬ 4 ç¢¼)
  document.querySelectorAll('input[name="bodypart"]').forEach((r) => {
    const c4 = r.value;
    if (selectedBodypart && c4 !== selectedBodypart) return; // å¦‚æœå·²é¸ï¼Œåªæª¢æŸ¥å·²é¸ä¸­çš„

    let ok = false;
    if (r.checked) ok = true; // å·²é¸ä¸­çš„æ°¸é åˆæ³• (é™¤éå…¶ä»–å·²é¸é …ç›®é€ æˆè¡çªï¼Œä½†é€™æœƒåœ¨å¾ŒçºŒæ­¥é©Ÿè™•ç†)
    
    if (!r.checked) {
      outer: for (let c5 of approachCandidates) {
        for (let c6 of deviceCandidates) {
          for (let c7 of qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              ok = true;
              break outer;
            }
          }
        }
      }
    }
    
    // æª¢æŸ¥å·²é¸é …ç›®æ˜¯å¦å­˜åœ¨è¡çª (åªæœ‰ç•¶ c4 è¢«é¸ä¸­æ™‚æ‰éœ€æª¢æŸ¥)
    if (r.checked) {
      let currentOk = false;
      outer: for (let c5 of selectedApproach ? [selectedApproach] : approachCandidates) {
        for (let c6 of selectedDevice ? [selectedDevice] : deviceCandidates) {
          for (let c7 of selectedQualifier ? [selectedQualifier] : qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              currentOk = true;
              break outer;
            }
          }
        }
      }
      if (!currentOk) {
        ok = false;
      }
    }

    r.disabled = !ok;
    r.parentElement.style.opacity = ok ? 1 : 0.35;
    if (!ok && r.checked) {
      r.checked = false;
      selections.bodypart = null;
    }
  });

  // Approach (ç¬¬ 5 ç¢¼)
  document.querySelectorAll('input[name="approach"]').forEach((r) => {
    const c5 = r.value;
    if (selectedApproach && c5 !== selectedApproach) return;

    let ok = false;
    if (r.checked) ok = true;

    if (!r.checked) {
      outer: for (let c4 of bodypartCandidates) {
        for (let c6 of deviceCandidates) {
          for (let c7 of qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              ok = true;
              break outer;
            }
          }
        }
      }
    }

    // æª¢æŸ¥å·²é¸é …ç›®æ˜¯å¦å­˜åœ¨è¡çª
    if (r.checked) {
      let currentOk = false;
      outer: for (let c4 of selectedBodypart ? [selectedBodypart] : bodypartCandidates) {
        for (let c6 of selectedDevice ? [selectedDevice] : deviceCandidates) {
          for (let c7 of selectedQualifier ? [selectedQualifier] : qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              currentOk = true;
              break outer;
            }
          }
        }
      }
      if (!currentOk) {
        ok = false;
      }
    }

    r.disabled = !ok;
    r.parentElement.style.opacity = ok ? 1 : 0.35;
    if (!ok && r.checked) {
      r.checked = false;
      selections.approach = null;
    }
  });

  // Device (ç¬¬ 6 ç¢¼)
  document.querySelectorAll('input[name="device"]').forEach((r) => {
    const c6 = r.value;
    if (selectedDevice && c6 !== selectedDevice) return;

    let ok = false;
    if (r.checked) ok = true;

    if (!r.checked) {
      outer: for (let c4 of bodypartCandidates) {
        for (let c5 of approachCandidates) {
          for (let c7 of qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              ok = true;
              break outer;
            }
          }
        }
      }
    }

    // æª¢æŸ¥å·²é¸é …ç›®æ˜¯å¦å­˜åœ¨è¡çª
    if (r.checked) {
      let currentOk = false;
      outer: for (let c4 of selectedBodypart ? [selectedBodypart] : bodypartCandidates) {
        for (let c5 of selectedApproach ? [selectedApproach] : approachCandidates) {
          for (let c7 of selectedQualifier ? [selectedQualifier] : qualCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              currentOk = true;
              break outer;
            }
          }
        }
      }
      if (!currentOk) {
        ok = false;
      }
    }

    r.disabled = !ok;
    r.parentElement.style.opacity = ok ? 1 : 0.35;
    if (!ok && r.checked) {
      r.checked = false;
      selections.device = null;
    }
  });

  // Qualifier (ç¬¬ 7 ç¢¼)
  document.querySelectorAll('input[name="qualifier"]').forEach((r) => {
    const c7 = r.value;
    if (selectedQualifier && c7 !== selectedQualifier) return;

    let ok = false;
    if (r.checked) ok = true;

    if (!r.checked) {
      outer: for (let c4 of bodypartCandidates) {
        for (let c5 of approachCandidates) {
          for (let c6 of deviceCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              ok = true;
              break outer;
            }
          }
        }
      }
    }

    // æª¢æŸ¥å·²é¸é …ç›®æ˜¯å¦å­˜åœ¨è¡çª
    if (r.checked) {
      let currentOk = false;
      outer: for (let c4 of selectedBodypart ? [selectedBodypart] : bodypartCandidates) {
        for (let c5 of selectedApproach ? [selectedApproach] : approachCandidates) {
          for (let c6 of selectedDevice ? [selectedDevice] : deviceCandidates) {
            if (isValidCombination(c4, c5, c6, c7)) {
              currentOk = true;
              break outer;
            }
          }
        }
      }
      if (!currentOk) {
        ok = false;
      }
    }

    r.disabled = !ok;
    r.parentElement.style.opacity = ok ? 1 : 0.35;
    if (!ok && r.checked) {
      r.checked = false;
      selections.qualifier = null;
    }
  });

  // 3. é‡æ–°è¨ˆç®—ä»£ç¢¼é¡¯ç¤º (å› ç‚ºå¯èƒ½æœ‰é¸é …è¢«æ¸…ç©º)
  updateSelectedCode();
}

// -------- æŸ¥è©¢ä¸»å‡½æ•¸ (å·²ä¿®æ”¹) --------
function doSearch() {
  if (!isLoaded) {
    resetTablePlaceholder("Tables XML å°šæœªè¼‰å…¥ã€‚");
    setResultInfo("è«‹ç­‰å¾… Tables æª”è¼‰å…¥å®Œæˆã€‚");
    resetSummaryHeader();
    currentPrefix = "";
    clearSelectionsBtn.disabled = true; // <-- ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
    return;
  }

  // å¾ Summary å€å¡Šå…§çš„ä¸‰å€‹ Select å…ƒç´ ä¸­ç²å–å‰ä¸‰ç¢¼
  const sCode = sectionSelect.value.trim().toUpperCase();
  const bsCode = bodySystemSelect.value.trim().toUpperCase();
  const opCode = operationSelect.value.trim().toUpperCase();
  const prefix = sCode + bsCode + opCode;

  if (prefix.length !== 3) {
    resetTablePlaceholder("è«‹å…ˆå®Œæ•´é¸æ“‡ Sectionã€Body System å’Œ Operation (å…± 3 ç¢¼)ã€‚");
    setResultInfo("è«‹é¸æ“‡å‰ 3 ç¢¼ã€‚");
    currentPrefix = "";
    clearSelectionsBtn.disabled = true; // <-- ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
    // å³ä½¿æ²’æœ‰ 3 ç¢¼ï¼Œä¹Ÿæ›´æ–° partial code é¡¯ç¤º
    updateSelectedCode();
    return;
  }
  
  // æª¢æŸ¥å‰ç¶´æ˜¯å¦çœŸçš„æ”¹è®Šï¼Œå¦‚æœæ²’æœ‰è®Šå‹•å‰‡ä¸éœ€è¦é‡ç½®é¸é …
  const prefixChanged = currentPrefix !== prefix;
  currentPrefix = prefix;

  const vm = validMap.get(prefix);

  if (!vm) {
    renderAxisTable([], prefix, 0); // æŸ¥ç„¡çµæœ
    resetSelections();
    clearSelectionsBtn.disabled = true; // <-- ç¦ç”¨æ¸…é™¤æŒ‰éˆ•
    return;
  }

  // å¦‚æœå‰ 3 ç¢¼æœ‰è®ŠåŒ–ï¼Œå‰‡æ¸…ç©º 4-7 ç¢¼çš„é¸æ“‡
  if (prefixChanged) {
    resetSelections();
  }

  // æ ¹æ“šå‰ä¸‰ç¢¼æ‰¾åˆ°æ‰€æœ‰å®Œæ•´çš„ 7 ç¢¼ä»£ç¢¼
  const totalMatched = vm.combos.size;
  
  // æ§‹é€ ä¸€å€‹åˆ—è¡¨ï¼ŒåŒ…å«è©²å‰ä¸‰ç¢¼ä¸‹æ‰€æœ‰å¯èƒ½çš„ [section/bs/op/bp/ap/dv/q] çµ„åˆ
  const matched = Array.from(vm.combos).map((code) => ({
    code: code,
    desc: icdCodeMap.get(code),
  }));

  // æ¸²æŸ“è¡¨æ ¼
  renderAxisTable(matched, prefix, totalMatched);
  
  // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼Œå˜—è©¦æ‡‰ç”¨æœ€å¯èƒ½çµ„åˆä¸¦éæ¿¾
  applyMostLikelyAndFilter();

  clearSelectionsBtn.disabled = false; // <-- å•Ÿç”¨æ¸…é™¤æŒ‰éˆ•
}

const debouncedSearch = debounce(doSearch, 100);

// -------- è™•ç† Index é»æ“Šï¼Œé¸å–åƒæ•¸ä»£ç¢¼ä¸¦é¸å–ä¸‹æ‹‰é¸å–®
function selectPrefixFromUrl(prefix) {
  if (prefix.length === 3) {
    const sCode = prefix[0];
    const bsCode = prefix[1];
    const opCode = prefix[2];

    // 1. é¸å– Section
    if (Array.from(sectionOptions.keys()).includes(sCode)) {
      sectionSelect.value = sCode;
      updateBodySystemSelect(sCode); // è¼‰å…¥ Body System é¸é …

      // 2. é¸å– Body System
      // ä½¿ç”¨ setTimeout ç¢ºä¿ updateBodySystemSelect å®Œæˆæ¸²æŸ“
      setTimeout(() => {
        const isBsValid = bodySystemOptions.has(sCode) && Array.from(bodySystemOptions.get(sCode).keys()).includes(bsCode);
        if (isBsValid) {
          bodySystemSelect.value = bsCode;
          updateOperationSelect(sCode, bsCode); // è¼‰å…¥ Operation é¸é …
          
          // 3. é¸å– Operation
          setTimeout(() => {
            const isOpValid = operationOptions.has(sCode + bsCode) && Array.from(operationOptions.get(sCode + bsCode).keys()).includes(opCode);
            if (isOpValid) {
              operationSelect.value = opCode;
              // 4. åŸ·è¡ŒæŸ¥è©¢
              doSearch();
            }
          }, 50); // ç¨å¾®å»¶é²ä»¥ç¢ºä¿ DOM æ›´æ–°
        }
      }, 50);
    }
  }
}

// -------- äº‹ä»¶ç›£è½ --------

// [æ–°å¢] ç›£è½ç›´æ¥è¼¸å…¥å‰ä¸‰ç¢¼çš„åŠŸèƒ½
if (prefixInput && searchPrefixBtn && prefixError) {
    // ç›£è½è¼¸å…¥æ¡†çš„è®Šå‹• (å¯¦æ™‚æª¢æŸ¥è¼¸å…¥é•·åº¦å’Œå…§å®¹)
    prefixInput.addEventListener('input', () => {
        const value = prefixInput.value.toUpperCase().trim();
        prefixInput.value = value; // è½‰å¤§å¯«å›å¡«
        // æª¢æŸ¥æ˜¯å¦ç‚ºä¸‰ä½è‹±æ•¸å­—
        const isValid = value.length === 3 && /^[0-9A-Z]{3}$/.test(value);
        
        // æ§åˆ¶æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹å’ŒéŒ¯èª¤è¨Šæ¯
        searchPrefixBtn.disabled = !isValid;
        prefixError.style.display = isValid || value.length === 0 ? 'none' : 'block';
    });

    // ç›£è½ã€ŒæŸ¥è©¢ã€æŒ‰éˆ•é»æ“Šäº‹ä»¶
    searchPrefixBtn.addEventListener('click', () => {
        if (searchPrefixBtn.disabled) return;
        const prefix = prefixInput.value.toUpperCase().trim();
        // å‘¼å«ç¾æœ‰çš„é¸æ“‡å‰ä¸‰ç¢¼çš„å‡½æ•¸
        selectPrefixFromUrl(prefix); 
    });

    // ç›£è½è¼¸å…¥æ¡†çš„ Enter éµ
    prefixInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !searchPrefixBtn.disabled) {
            searchPrefixBtn.click(); // æ¨¡æ“¬é»æ“ŠæŸ¥è©¢æŒ‰éˆ•
            e.preventDefault(); // é¿å…è¡¨å–®æˆ–å…¶ä»–é è¨­è¡Œç‚º
        }
    });
}


// å¾ Summary å€å¡Šçš„ Select å…ƒç´ è®Šå‹•æ™‚è§¸ç™¼æŸ¥è©¢
sectionSelect.addEventListener("change", (e) => {
  updateBodySystemSelect(e.target.value.toUpperCase());
});

bodySystemSelect.addEventListener("change", (e) => {
  const sCode = sectionSelect.value.toUpperCase();
  updateOperationSelect(sCode, e.target.value.toUpperCase());
});

operationSelect.addEventListener("change", (e) => {
  debouncedSearch();
});

// è™•ç† Index Search Input
const debouncedIndexSearch = debounce(searchIndex, 300);
indexSearchInput.addEventListener("input", debouncedIndexSearch);

function searchIndex() {
  const query = indexSearchInput.value.trim();
  
  if (!query) {
    indexResultBox.innerHTML = `
      <div class="index-result-empty">
        ç›®å‰å°šæœªè¼‰å…¥ Index XMLï¼Œæˆ–å°šæœªè¼¸å…¥è™•ç½®åç¨±ã€‚
      </div>
    `;
    return;
  }
  
  if (!indexLoaded) {
      indexResultBox.innerHTML = `
        <div class="index-result-empty error" style="color: #b91c1c;">
          Index XML å°šæœªè¼‰å…¥ã€‚
        </div>
      `;
      return;
  }

  // 1. åŸ·è¡Œéæ¿¾ (ä¸å€åˆ†å¤§å°å¯«)
  const lowerQuery = query.toLowerCase();
  const filteredEntries = indexEntries.filter((entry) =>
    entry.path.toLowerCase().includes(lowerQuery)
  );
  
  // 2. æ¸²æŸ“çµæœ
  if (filteredEntries.length === 0) {
    indexResultBox.innerHTML = `
      <div class="index-result-empty">
        æŸ¥ç„¡ç¬¦åˆã€Œ${escapeHtmlAttr(query)}ã€çš„è™•ç½®åç¨±ã€‚
      </div>
    `;
    return;
  }

  let html = "";
  filteredEntries.slice(0, 50).forEach((entry) => {
    html += `
      <div class="index-result-item">
        <div class="index-path">${entry.path}</div>
        <div class="index-codes">
          ${entry.codes
            .map(
              (code) =>
                `<span class="index-code-chip" data-code="${code}">${code.substring(0, 3).toUpperCase()}...</span>`
            )
            .join("")}
        </div>
      </div>
    `;
  });
  
  // é¡¯ç¤ºçµæœæ•¸é‡å’Œæç¤º
  const infoText = filteredEntries.length > 50 ? `(åƒ…é¡¯ç¤ºå‰ 50 æ¢çµæœï¼Œç¸½è¨ˆ ${filteredEntries.length} æ¢)` : '';
  
  indexResultBox.innerHTML = html;
  
  const tip = document.createElement('div');
  tip.className = 'index-tip';
  tip.textContent = `æç¤º: é»æ“Šä»£ç¢¼ (ä¾‹å¦‚ï¼š0CT) å¯è‡ªå‹•å¸¶å…¥å‰ 3 ç¢¼é€²è¡ŒæŸ¥è©¢ã€‚ ${infoText}`;
  indexResultBox.appendChild(tip);
}

// ç›£è½è¡¨æ ¼å…§çš„ Radio Button è®Šå‹• (ç¬¬ 4-7 ç¢¼)
resultBody.addEventListener("change", (e) => {
  const target = e.target;
  if (target.type === "radio") {
    const name = target.name;
    selections[name] = target.value;
    applyMostLikelyAndFilter(); // é€™è£¡æœƒè§¸ç™¼ updateSelectedCode
  }
});

// é» Index çµæœä»£ç¢¼ â†’ å¸¶å…¥å‰ä¸‰ç¢¼ä¸¦æŸ¥è©¢
indexResultBox.addEventListener("click", (e) => {
  const target = e.target.closest(".index-code-chip");
  if (!target) return;
  const code = target.dataset.code;
  if (code) {
    const prefix = code.substring(0, 3).toUpperCase(); 
    selectPrefixFromUrl(prefix); // ä½¿ç”¨ç›¸åŒçš„é‚è¼¯ä¾†è™•ç†é»æ“Šäº‹ä»¶
  }
});

// æ–°å¢ï¼šæ¸…é™¤å·²é¸æ“‡ Body Part (4-7 ç¢¼) çš„æŒ‰éˆ•ç›£è½
clearSelectionsBtn.addEventListener("click", () => {
    if (clearSelectionsBtn.disabled) return;
    
    // 1. é‡ç½® Body Part, Approach, Device, Qualifier çš„é¸æ“‡
    resetSelections(); 
    
    // 2. é‡æ–°æ‡‰ç”¨æœ€å¯èƒ½çµ„åˆä¸¦éæ¿¾éæ³•é¸é …ï¼Œé€™æœƒæ›´æ–°è¡¨æ ¼å’Œä»£ç¢¼é¡¯ç¤º
    applyMostLikelyAndFilter(); 
});


// -------- é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ --------
document.addEventListener("DOMContentLoaded", async () => {
    // é é¢å•Ÿå‹•æ™‚é¡¯ç¤ºè¼‰å…¥ä¸­
    updateIntegratedStatus('tables', LOAD_STATUS.LOADING); 
    updateIntegratedStatus('definitions', LOAD_STATUS.LOADING);
    updateIntegratedStatus('index', LOAD_STATUS.LOADING);

    // å¹³è¡Œè¼‰å…¥æ‰€æœ‰æª”æ¡ˆ
    await Promise.all([
        loadTables(),
        loadDefinitions(),
        loadIndex()
    ]);
});
  </script>
</body>
</html>